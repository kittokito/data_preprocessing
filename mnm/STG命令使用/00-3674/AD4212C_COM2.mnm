DEVICE:53
;MODULE:AD4212C_COM2
;MODULE_TYPE:0
;SCRIPT_TYPE:
;PCとの通信
LDP R46104               ; _ESTOP_MODE
ZRES @R100 @R315
;<h1/>Comunication MAIN
;
;Command Number Description (EM1920) 
;# Continuous output request 0 'SIR' weight value 
;# Stop continuous output of 1 'C' weight value 
;# Weight value data request 2 'S' after stabilization 
;
;# Stop continuous output of 11 'C' weight value 
;# 12 'R' Tare (RE-ZERO) 
;
;# Continuous reception of 20 measured values (no transmission)
;
;ｺﾏﾝﾄﾞ番号説明　(EM1920)
;#0	'SIR'	計量値の連続出力要求
;#1	'C'		計量値の連続出力の停止
;#2	'S'		安定後計量値ﾃﾞｰﾀ要求
;
;#11	'C'		計量値の連続出力の停止
;#12	'R'		風袋引き(RE-ZERO)
;
;#20	　　　　計量値の連続受信(送信無）
LD CR2005                ; 100msｸﾛｯｸﾊﾟﾙｽ
ANB R37010               ; AD4212C-2通信中
AND= EM1922 #20          ; 天秤2 処理ｺﾏﾝﾄﾞNO
AND= DM3000 #506         ; 表示中 画面No.
AND R37015               ; 天秤2 連続計量 FLG
@SET R37008              ; AD4212C-2通信開始
STG R37008               ; AD4212C-2通信開始
RES R37009               ; AD4212C-2通信完了
CON
ZRES DM25859 DM26114     ; Port2 受信ﾃﾞｰﾀ1  Port2 受信ﾃﾞｰﾀ256
CON
RES @R301
CON
SET R37010               ; AD4212C-2通信中
CON
ZRES @DM0 @DM12
CON
ZRES @DM16 @DM999
CON
JMP @R100
STG @R100
LDA EM1922               ; 天秤2 処理ｺﾏﾝﾄﾞNO
CON
STA @DM7
CON
LDA EM1922               ; 天秤2 処理ｺﾏﾝﾄﾞNO
CON
STA @DM50
CON
JMP @R101
;<<Send and receive commands>>
STG @R101
MPS
AND= #0 @DM50
SMOV "SIR" @DM100
JMP @R200
MRD
AND= #1 @DM50
SMOV "C" @DM100
JMP @R200
MRD
AND= #2 @DM50
SMOV "S" @DM100
JMP @R200
MRD
AND= #11 @DM50
SMOV "C" @DM100
JMP @R200
MRD
AND= #12 @DM50
SMOV "R" @DM100
JMP @R200
MPP
AND= #20 @DM50
JMP @R200
;<<receive >
STG @R102
JMP @R200
;<h1/>General-purpose cominucation 
STG @R200
ANB @R302
SET @R300
CON
JMP @R201
STG @R201
AND @R301
MPS
ANB @R303
RES @R301
CON
JMP @R205
MPP
AND @R303
RES @R301
CON
JMP @R202
STG @R202
SET R37011               ; 送受信異常2
CON
RES @R303
CON
JMP @R205
STG @R205
SET R37009               ; AD4212C-2通信完了
CON
RES R37010               ; AD4212C-2通信中
CON
ENDS
;<h1/>SERIAL cominucation START
;'SERIAL_COM ﾏｸﾛ使用する為に以下の設定を行う
;@DM0 = $0000	'ﾃﾞｰﾀ格納単位設定
;@DM1 = $0000	'ﾓｰﾄﾞ設定
;@DM2 = #0000	'ﾀｲﾑｱｳﾄﾁｪｯｸ時間設定
;@DM3 = $0000	'送信用ﾍｯﾀﾞ設定
;@DM4 = $0D0A	'送信用ﾃﾞﾘﾐﾀ設定
;@DM5 = $0000	'受信用ﾍｯﾀﾞ設定
;@DM6 = $0D0A	'受信用ﾃﾞﾘﾐﾀ設定
LD CR2002                ; 常時ON
NCJ #1000
;'SERIAL_COM ﾏｸﾛ使用する為に以下の設定を行う
;
;@DM0 = $0000	'ﾃﾞｰﾀ格納単位設定
;
LD CR2002                ; 常時ON
MOV $0000 @DM0
;@DM1 = $0000	'ﾓｰﾄﾞ設定
;
LD CR2002                ; 常時ON
MOV $0000 @DM1
;@DM2 = #0000	'ﾀｲﾑｱｳﾄﾁｪｯｸ時間設定
;
LD CR2002                ; 常時ON
MOV #0 @DM2
;@DM3 = $0000	'送信用ﾍｯﾀﾞ設定
;
LD CR2002                ; 常時ON
MOV $0000 @DM3
;@DM4 = $0D0A	'送信用ﾃﾞﾘﾐﾀ設定
;
LD CR2002                ; 常時ON
MOV $0D0A @DM4
;@DM5 = $0000	'受信用ﾍｯﾀﾞ設定
;
LD CR2002                ; 常時ON
MOV $0000 @DM5
;@DM6 = $0D0A	'受信用ﾃﾞﾘﾐﾀ設定
LD CR2002                ; 常時ON
MOV $0D0A @DM6
LABEL #1000
;
STG @R300
SET @R302
CON
DW #0 @DM10
CON
JMP @R304
LDP @R304
MSTRT SERIAL_COM2 R25200 DM25600 @DM0 @DM100 @DM500 @DM10;Port2 通信可能
STG @R304
MPS
AND= @DM10 #20
JMP @R305
MPP
LD<> @DM10 #20
AND<> @DM10 #0
ANL
SET @R303
CON
JMP @R315
;Send and receive commands 
;Measurement data storage processing branch
STG @R305
MPS
LD= EM1922 #1            ; 天秤2 処理ｺﾏﾝﾄﾞNO
OR= EM1922 #11           ; 天秤2 処理ｺﾏﾝﾄﾞNO
ANL
JMP @R315
MPP
LD= EM1922 #0            ; 天秤2 処理ｺﾏﾝﾄﾞNO
OR= EM1922 #2            ; 天秤2 処理ｺﾏﾝﾄﾞNO
OR= EM1922 #12           ; 天秤2 処理ｺﾏﾝﾄﾞNO
OR= EM1922 #20           ; 天秤2 処理ｺﾏﾝﾄﾞNO
ANL
@FMOV #0 EM30200 #10     ; ST(② weight ASC Byte)
@BMOV DM25859 EM30200 #10; Port2 受信ﾃﾞｰﾀ1  ST(② weight ASC Byte)
@BMOV EM30203 EM30210 #3 ; 01(② weight ASC Byte)  01(② weight ASC Byte)
@DISS EM30210 EM30220    ; 01(② weight ASC Byte)  00(② weight ASC Byte)
@SMOV "･0" EM30226       ; 00(② weight ASC Byte)
@UNIS EM30221 EM30230 #6 ; 01(② weight ASC Byte)  12(② weight ASC Byte)
@BMOV EM30230 EM30250 #3 ; 12(② weight ASC Byte)  12(② weight ASC Byte)
@RFASC EM30250 EM30280   ; 12(② weight ASC Byte)  12.34(② weight FLOTE)
MPS
LDA.F EM30280            ; 12.34(② weight FLOTE)
CON
MUL.F +100
CON
STA.F EM30290            ; 1234(② weight FLOTE)
MRD
LDA.L EM30290            ; 1234(② weight FLOTE)
CON
INTG.L
CON
STA.L EM30300            ; 1234(② weight ±10進32bit)
MPP
JMP @R315
STG @R315
TMS @0 #10
CON
AND @T0
SET @R301
CON
RES @R302
CON
ENDS
END
ENDH
