DEVICE:53
;MODULE:SERIAL_COM3
;MODULE_TYPE:1
;SCRIPT_TYPE:
;SERIAL  Macro
;
;-----------------------------------------
;Macro Name 	: 	SERIAL_N_COM
;Macro Type	:	Self Holding
;Ver.		:	1.1
;Function	:	SERIAL 無手順 NORMAL ﾀｲﾌﾟﾏｸﾛ
;-----------------------------------------
;引数：
;	P0	=	ﾕﾆｯﾄ先頭R番地		R番号で指定		
;	P1	=	ﾕﾆｯﾄ先頭DM番地		DM番号で指定	
;	P2	=	設定用								
;	P3	=	送信内容先頭		文字列
;	P4	=	受信内容先頭		文字列
;	P5	=	Result code								
;			#20			=	正常終了				
;			#21			=	正常終了				
;
;
LD @CR2008
MPS
AND<> P2:#7 #20          ; 設定用
SET @MR000
MPP
AND= P2:#7 #20           ; 設定用
SET @MR100
;通信設定
;'ﾃﾞｰﾀ格納単位設定
;	P1.U:#515 = P2.U:#0
;'ﾓｰﾄﾞ設定
;	P1.U:#516 = P2.U:#1
;'ﾀｲﾑｱｳﾄﾁｪｯｸ時間設定
;	P1.U:#517 = P2.U:#2
;'送信用ﾍｯﾀﾞ設定
;	P1.U:#518 = P2.U:#3
;'送信用ﾃﾞﾘﾐﾀ設定
;	P1.U:#519 = P2.U:#4
;'受信用ﾍｯﾀﾞ設定
;	P1.U:#520 = P2.U:#5
;'受信用ﾃﾞﾘﾐﾀ設定
;	P1.U:#521 = P2.U:#6
LD CR2002                ; Normal ON
NCJ #1000
;'ﾃﾞｰﾀ格納単位設定
;
;	P1.U:#515 = P2.U:#0
;
LD CR2002                ; Normal ON
MOV P2 P1:#515           ; 設定用  ﾕﾆｯﾄ先頭DM
;'ﾓｰﾄﾞ設定
;
;	P1.U:#516 = P2.U:#1
;
LD CR2002                ; Normal ON
MOV P2:#1 P1:#516        ; 設定用  ﾕﾆｯﾄ先頭DM
;'ﾀｲﾑｱｳﾄﾁｪｯｸ時間設定
;
;	P1.U:#517 = P2.U:#2
;
LD CR2002                ; Normal ON
MOV P2:#2 P1:#517        ; 設定用  ﾕﾆｯﾄ先頭DM
;'送信用ﾍｯﾀﾞ設定
;
;	P1.U:#518 = P2.U:#3
;
LD CR2002                ; Normal ON
MOV P2:#3 P1:#518        ; 設定用  ﾕﾆｯﾄ先頭DM
;'送信用ﾃﾞﾘﾐﾀ設定
;
;	P1.U:#519 = P2.U:#4
;
LD CR2002                ; Normal ON
MOV P2:#4 P1:#519        ; 設定用  ﾕﾆｯﾄ先頭DM
;'受信用ﾍｯﾀﾞ設定
;
;	P1.U:#520 = P2.U:#5
;
LD CR2002                ; Normal ON
MOV P2:#5 P1:#520        ; 設定用  ﾕﾆｯﾄ先頭DM
;'受信用ﾃﾞﾘﾐﾀ設定
;
;	P1.U:#521 = P2.U:#6
LD CR2002                ; Normal ON
MOV P2:#6 P1:#521        ; 設定用  ﾕﾆｯﾄ先頭DM
LABEL #1000
;
;送信内容格納
;'送信ﾃﾞｰﾀ長設定
;	P1.U:#1 = LEN ( P3.T )
;'送信ﾃﾞｰﾀ格納
;'Ver.2で使用可能
;	'BYBMOV (P3,0,P1:#2,0,P1:#1)
;'Ver.1はこれで代用
;	BMOV (P3,P1:#2,P1:#1)
;'終了ﾋﾞｯﾄをSET
;	SET (@MR2)
LD @MR001
NCJ #1001
;'送信ﾃﾞｰﾀ長設定
;
;	P1.U:#1 = LEN ( P3.T )
;
LD CR2002                ; Normal ON
MOV #0 @VM0
LEN P3 @VM0              ; 送信内容先頭
LD CR2002                ; Normal ON
MOV @VM0 P1:#1           ; ﾕﾆｯﾄ先頭DM
;'送信ﾃﾞｰﾀ格納
;
;'Ver.2で使用可能
;
;	'BYBMOV (P3,0,P1:#2,0,P1:#1)
;
;'Ver.1はこれで代用
;
;	BMOV (P3,P1:#2,P1:#1)
;
LD CR2002                ; Normal ON
BMOV P3 P1:#2 P1:#1      ; 送信内容先頭  ﾕﾆｯﾄ先頭DM  ﾕﾆｯﾄ先頭DM
;'終了ﾋﾞｯﾄをSET
;
;	SET (@MR2)
LD CR2002                ; Normal ON
SET @MR002
LABEL #1001
;
;受信内容格納
;'受信ﾃﾞｰﾀ長設定
;	P1.U:#1 = LEN ( P3.T )
;'受信ﾃﾞｰﾀ格納
;'Ver.2で使用可能
;	'BYBMOV (P1:#259,0,P4:#2,0,LEN (P1.T:#259))
;'Ver.1はこれで代用
;	BMOV (P1:#259,P4,((LEN (P1.T:#259) + 1) / 2)) 
;'終了ﾋﾞｯﾄをSET
;	SET (@MR5)
LD @MR104
NCJ #1002
;'受信ﾃﾞｰﾀ長設定
;
;	P1.U:#1 = LEN ( P3.T )
;
LD CR2002                ; Normal ON
MOV #0 @VM1
LEN P3 @VM1              ; 送信内容先頭
LD CR2002                ; Normal ON
MOV @VM1 P1:#1           ; ﾕﾆｯﾄ先頭DM
;'受信ﾃﾞｰﾀ格納
;
;'Ver.2で使用可能
;
;	'BYBMOV (P1:#259,0,P4:#2,0,LEN (P1.T:#259))
;
;'Ver.1はこれで代用
;
;	BMOV (P1:#259,P4,((LEN (P1.T:#259) + 1) / 2)) 
;
LD CR2002                ; Normal ON
MOV #0 @VM2
LEN P1:#259 @VM2         ; ﾕﾆｯﾄ先頭DM
LD CR2002                ; Normal ON
LDA @VM2
CON
EXT
CON
ADD.L +1
CON
EXT.L
CON
DIV.L +2
CON
STA.L @VM3
BMOV P1:#259 P4 @VM3     ; ﾕﾆｯﾄ先頭DM  受信内容先頭
;'終了ﾋﾞｯﾄをSET
;
;	SET (@MR5)
LD CR2002                ; Normal ON
SET @MR005
LABEL #1002
;
;送信MAIN
STG @MR000
MPS
AND @R000
JMP @MR001
MPP
ANB @R000
SET @R100
CON
JMP @MR001
STG @MR001
AND @R000
AND @MR002
RES @MR002
CON
SET @R101
CON
JMP @MR003
STG @MR003
AND @R001
MPS
ANB @R004
JMP @MR004
MPP
AND @R004
RES @R101
CON
JMP @MR007
STG @MR004
RES @R101
CON
MPS
LD= P2:#7 #0             ; 設定用
OR= P2:#7 #1             ; 設定用
OR= P2:#7 #11            ; 設定用
OR= P2:#7 #12            ; 設定用
ANL
JMP @MR006
MPP
LD<> P2:#7 #0            ; 設定用
AND<> P2:#7 #1           ; 設定用
AND<> P2:#7 #11          ; 設定用
AND<> P2:#7 #12          ; 設定用
ANL
JMP @MR100
STG @MR006
ANB @R001
DW #20 @EM0
CON
JMP @MR015
STG @MR007
ANB @R001
DW #21 @EM0
CON
JMP @MR015
;受信MAIN
STG @MR100
MPS
AND @R000
JMP @MR101
MPP
ANB @R000
SET @R100
CON
JMP @MR101
STG @MR101
AND @R000
JMP @MR103
STG @MR103
MPS
LD @R002
ANB @R003
ANB @R004
ANL
JMP @MR104
MPP
LD @R003
OR @R004
ANL
JMP @MR107
STG @MR104
AND @MR005
SET @R102
CON
RES @MR005
CON
JMP @MR106
STG @MR106
ANB @R002
RES @R102
CON
DW #20 @EM0
CON
JMP @MR015
STG @MR107
ANB @R002
RES @R102
CON
DW #21 @EM0
CON
JMP @MR015
;I/O置換
;IN
LD P0:#0                 ; ﾕﾆｯﾄ先頭R
OUT @R000
LD P0:#1                 ; ﾕﾆｯﾄ先頭R
OUT @R001
LD P0:#2                 ; ﾕﾆｯﾄ先頭R
OUT @R002
LD P0:#3                 ; ﾕﾆｯﾄ先頭R
OUT @R003
LD P0:#4                 ; ﾕﾆｯﾄ先頭R
OUT @R004
LD P0:#5                 ; ﾕﾆｯﾄ先頭R
OUT @R005
LD P0:#6                 ; ﾕﾆｯﾄ先頭R
OUT @R006
LD P0:#7                 ; ﾕﾆｯﾄ先頭R
OUT @R007
LD P0:#8                 ; ﾕﾆｯﾄ先頭R
OUT @R008
LD P0:#9                 ; ﾕﾆｯﾄ先頭R
OUT @R009
LD P0:#10                ; ﾕﾆｯﾄ先頭R
OUT @R010
LD P0:#11                ; ﾕﾆｯﾄ先頭R
OUT @R011
LD P0:#12                ; ﾕﾆｯﾄ先頭R
OUT @R012
LD P0:#13                ; ﾕﾆｯﾄ先頭R
OUT @R013
LD P0:#14                ; ﾕﾆｯﾄ先頭R
OUT @R014
LD P0:#15                ; ﾕﾆｯﾄ先頭R
OUT @R015
;OUT
LD @R100
OUT P0:#16               ; ﾕﾆｯﾄ先頭R
LD @R101
OUT P0:#17               ; ﾕﾆｯﾄ先頭R
LD @R102
OUT P0:#18               ; ﾕﾆｯﾄ先頭R
LD @R103
OUT P0:#19               ; ﾕﾆｯﾄ先頭R
LD @R104
OUT P0:#20               ; ﾕﾆｯﾄ先頭R
LD @R105
OUT P0:#21               ; ﾕﾆｯﾄ先頭R
LD @R106
OUT P0:#22               ; ﾕﾆｯﾄ先頭R
LD @R107
OUT P0:#23               ; ﾕﾆｯﾄ先頭R
LD @R108
OUT P0:#24               ; ﾕﾆｯﾄ先頭R
LD @R109
OUT P0:#25               ; ﾕﾆｯﾄ先頭R
LD @R110
OUT P0:#26               ; ﾕﾆｯﾄ先頭R
LD @R111
OUT P0:#27               ; ﾕﾆｯﾄ先頭R
LD @R112
OUT P0:#28               ; ﾕﾆｯﾄ先頭R
LD @R113
OUT P0:#29               ; ﾕﾆｯﾄ先頭R
LD @R114
OUT P0:#30               ; ﾕﾆｯﾄ先頭R
LD @R115
OUT P0:#31               ; ﾕﾆｯﾄ先頭R
STG @MR015
LDA @EM0
CON
STA P5                   ; Result_code
CON
ENDS
MEND
END
ENDH
