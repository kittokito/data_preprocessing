DEVICE:53
;MODULE:MC_MOVE_PLS
;MODULE_TYPE:1
;SCRIPT_TYPE:
;OneSystem SupportMacro
;広丘
;-----------------------------------------
;Macro Name 	: 	MC_MOVE
;Macro Type	:	Self Holding
;Ver.		:	1.1
;Function	:	MC Unit Move
;-----------------------------------------
;引数：
;	V0	=  目標位置						    V0	=  Target Position Value
;	V1 	=  速度					        	V1  =  Speed
;	V2	=  加減速						    V2	=  G
;	V3  =  RB_TYPE[2,0~31]                  V3  =  RB_TYPE[2,0~31]
;	P0	=	完了コード					    P0  =  Macro Complete Code
;			#20			=	正常終了				#20 		=	No Error
;			#21			=	RB応答なし				#21 		=	Non Responce
;			#22			=	ｽﾃｰﾀｽ異常		 	    #22 		=	Status Abnormal
;			#23         =   速度設定異常            #23         =   Speed Setting Abnormal
;			#24         =   Driver ALARM  		    #24         =   Driver ALARM
;							
;
;機能：MC UnitによるPULSE列 軸制御  /  Axis PULSE Control From MC Unit
;
LD R59915                ; _運転ﾓｰﾄﾞ指定
ORP R46104               ; _非常停止中　ﾓｰﾄﾞﾌﾗｸﾞ
OR MR20105               ; ｴﾘｱｾﾝｻ遮光検出
ZRES @R000 @R015         ; ﾏｸﾛ実行  ｱﾗｰﾑ発生
CON
MEND
;'MC制御軸の場合のみ実行  UNIT,AXIS No.割出
;
;@DM2.T=STR(RB_TYPE[2,V3]) 'UNIT,AXIS 読出し桁分割
;DISB( @DM2,@EM100,2)
;BSWAP(@EM100,2)
;@DM6= RDASC(@EM100.T)		     'AXIS No.格納
;@DM7= RDASC(@EM101.T)			 'UNIT No.格納
;
;
;@DM22=(W3AE0:(@DM7*4)*16)+((@DM6-1)*8)	'制御ﾃﾞﾊﾞｲｽ修飾
;@DM24=(W3AE0:(@DM7*4)*16)+((@DM6-1)*128)'制御STATUSﾃﾞﾊﾞｲｽ
;@DM26=#440+((@DM6-1)*40) 				'位置決め完了Code
;ADRSET(R0:@DM22,Control)			'位置決め開始ﾃﾞﾊﾞｲｽｾｯﾄ
;ADRSET(R0:@DM24,STATUS)		        '制御STATUSﾃﾞﾊﾞｲｽｾｯﾄ
;
;'MC制御軸の場合のみ実行  UNIT,AXIS No.割出
;
;@DM2.T=STR(RB_TYPE[2,V3]) 'UNIT,AXIS 読出し桁分割
;
LD CR2002                ; 常時ON
LDA V3                   ; Arrange_No.
CON
EXT
CON
ADD.L +64
CON
STA.L Z12
LD CR2002                ; 常時ON
ADRSET VM2 VM0
MOV #0 VM2
MOV.D VM0 @VM1
LD CR2002                ; 常時ON
MOV CR2800 @VM0          ; ﾌﾞﾚｰｸ信号送出
SET CR2814               ; ASCII変換ｾﾞﾛｻﾌﾟﾚｽ設定
SET CR2815               ; ASCII変換+符号省略
DASC W3A25:Z12 *@VM1     ; RB1 TYPE
MOV @VM0 CR2800          ; ﾌﾞﾚｰｸ信号送出
LD CR2002                ; 常時ON
SMOV *@VM1 @DM2
;DISB( @DM2,@EM100,2)
;
LD CR2002                ; 常時ON
DISB @DM2 @EM100 #2
;BSWAP(@EM100,2)
;
LD CR2002                ; 常時ON
BSWAP @EM100 #2
;@DM6= RDASC(@EM100.T)		     'AXIS No.格納
;
LD CR2002                ; 常時ON
MOV.L +0 @VM3
RDASC.L @EM100 @VM3
LD CR2002                ; 常時ON
MOV @VM3 @DM6            ; Axis_No
;@DM7= RDASC(@EM101.T)			 'UNIT No.格納
;
LD CR2002                ; 常時ON
MOV.L +0 @VM5
RDASC.L @EM101 @VM5
LD CR2002                ; 常時ON
MOV @VM5 @DM7            ; UNIT_No.
;@DM22=(W3AE0:(@DM7*4)*16)+((@DM6-1)*8)	'制御ﾃﾞﾊﾞｲｽ修飾
;
LD CR2002                ; 常時ON
LDA @DM6                 ; Axis_No
CON
EXT
CON
SUB.L +1
CON
MUL.L +8
CON
STA.L @VM7
CON
LDA @DM7                 ; UNIT_No.
CON
EXT
CON
MUL.L +4
CON
STA.L Z12
CON
LDA W3AE0:Z12            ; UNIT_0 R
CON
EXT
CON
MUL.L +16
CON
ADD.L @VM7
CON
STA @DM22
;@DM24=(W3AE0:(@DM7*4)*16)+((@DM6-1)*128)'制御STATUSﾃﾞﾊﾞｲｽ
;
LD CR2002                ; 常時ON
LDA @DM6                 ; Axis_No
CON
EXT
CON
SUB.L +1
CON
MUL.L +128
CON
STA.L @VM9
CON
LDA @DM7                 ; UNIT_No.
CON
EXT
CON
MUL.L +4
CON
STA.L Z12
CON
LDA W3AE0:Z12            ; UNIT_0 R
CON
EXT
CON
MUL.L +16
CON
ADD.L @VM9
CON
STA @DM24
;@DM26=#440+((@DM6-1)*40) 				'位置決め完了Code
;
LD CR2002                ; 常時ON
LDA @DM6                 ; Axis_No
CON
EXT
CON
SUB.L +1
CON
MUL.L +40
CON
ADD.L +440
CON
STA @DM26                ; 位置決め完了Codeﾃﾞﾊﾞｲｽ修飾
;ADRSET(R0:@DM22,Control)			'位置決め開始ﾃﾞﾊﾞｲｽｾｯﾄ
;
LD CR2002                ; 常時ON
LDA @DM22
CON
EXT
CON
STA.L Z12
ADRSET R000:Z12 Control  ; 非常停止SW  位置決め制御先頭ﾘﾚｰ
;ADRSET(R0:@DM24,STATUS)		        '制御STATUSﾃﾞﾊﾞｲｽｾｯﾄ
;
LD CR2002                ; 常時ON
LDA @DM24
CON
EXT
CON
STA.L Z12
ADRSET R000:Z12 STATUS   ; 非常停止SW  位置決めSTATUSﾘﾚｰ
;
;入力
LD *Control:#128         ; 位置決め制御先頭ﾘﾚｰ
OUT START_OK             ; START OK
LD *Control:#130         ; 位置決め制御先頭ﾘﾚｰ
OUT MOVE_END             ; MOVE END
LD *STATUS:#704          ; 位置決めSTATUSﾘﾚｰ
OUT AXIS_ERR             ; Axis ERROR
LD *STATUS:#705          ; 位置決めSTATUSﾘﾚｰ
OUT AXIS_WARNING         ; Axis Warnig
LD *STATUS:#708          ; 位置決めSTATUSﾘﾚｰ
OUT BUSY                 ; Busy
LD *STATUS:#757          ; 位置決めSTATUSﾘﾚｰ
OUT DRV_ALM              ; Driver ALARM
;--
LD @CR2008
SET @R000                ; ﾏｸﾛ実行
STG @R000                ; ﾏｸﾛ実行
SET @R002                ; ﾏｸﾛ実行中
CON
JMP @R003
;書き込み 目標値 速度 加減速時間
;最小単位 目標値=0.01mm、速度=mm/s、加減速=0.01G
;※桁に注意 ：軸設定により桁が変ります。デフォルトでは、最小単位が0.01mmとなっています。
STG @R003
AND @R004
JMP @R005
;@DM10.D=V1	'速度
;@DM12.D=FLOAT(V2)'加速度
;@DM14.D=@DM12.D     						     '減速0.01mm/s
;@DM16.U=(@DM6-1)*32+18016						 '目標値 軸OFFSET
;@DM18.U=(@DM6-1)*32+18028						 '速度,加減速 軸OFFSET
;@DM20.U=(28-1)+@DM6		                         '位置決め開始ﾎﾟｲﾝﾄ番号指定 軸ｵﾌｾｯﾄ
;
;'POINT1番にデータ書き込
;UWRIT(@DM7,@DM16,V0,#2)   '目標値格納
;UWRIT(@DM7,@DM18,@DM10,#6)'速度、加減速格納
;UWRIT(@DM7,@DM20,#1,#1)   '位置決め開始ﾎﾟｲﾝﾄ指定
;SET (@R4)
LD @R003
ANB @R004
NCJ #1000
;@DM10.D=V1	'速度
;
LD CR2002                ; 常時ON
LDA V1                   ; SPEED
CON
EXT
CON
STA.D @DM10              ; 速度
;@DM12.D=FLOAT(V2)'加速度
;
LD CR2002                ; 常時ON
LDA V2                   ; G
CON
FLOAT
CON
INTG.D
CON
STA.D @DM12              ; 加速時間
;@DM14.D=@DM12.D     						     '減速0.01mm/s
;
LD CR2002                ; 常時ON
MOV.D @DM12 @DM14        ; 加速時間  減速時間
;@DM16.U=(@DM6-1)*32+18016						 '目標値 軸OFFSET
;
LD CR2002                ; 常時ON
LDA @DM6                 ; Axis_No
CON
EXT
CON
SUB.L +1
CON
MUL.L +32
CON
ADD.L +18016
CON
STA @DM16                ; 目標値ﾊﾞｯﾌｧﾒﾓﾘ
;@DM18.U=(@DM6-1)*32+18028						 '速度,加減速 軸OFFSET
;
LD CR2002                ; 常時ON
LDA @DM6                 ; Axis_No
CON
EXT
CON
SUB.L +1
CON
MUL.L +32
CON
ADD.L +18028
CON
STA @DM18                ; 速度ﾊﾞｯﾌｧﾒﾓﾘ
;@DM20.U=(28-1)+@DM6		                         '位置決め開始ﾎﾟｲﾝﾄ番号指定 軸ｵﾌｾｯﾄ
;
LD CR2002                ; 常時ON
LDA @DM6                 ; Axis_No
CON
EXT
CON
ADD.L +27
CON
STA @DM20                ; ﾎﾟｲﾝﾄﾊﾞｯﾌｧﾒﾓﾘ
;'POINT1番にデータ書き込
;
;UWRIT(@DM7,@DM16,V0,#2)   '目標値格納
;
LD CR2002                ; 常時ON
UWRIT @DM7 @DM16 V0 #2   ; UNIT_No.  目標値ﾊﾞｯﾌｧﾒﾓﾘ  POS
;UWRIT(@DM7,@DM18,@DM10,#6)'速度、加減速格納
;
LD CR2002                ; 常時ON
UWRIT @DM7 @DM18 @DM10 #6; UNIT_No.  速度ﾊﾞｯﾌｧﾒﾓﾘ  速度
;UWRIT(@DM7,@DM20,#1,#1)   '位置決め開始ﾎﾟｲﾝﾄ指定
;
LD CR2002                ; 常時ON
UWRIT @DM7 @DM20 #1 #1   ; UNIT_No.  ﾎﾟｲﾝﾄﾊﾞｯﾌｧﾒﾓﾘ
;SET (@R4)
LD CR2002                ; 常時ON
SET @R004
LABEL #1000
;
;位置決め開始
STG @R005
RES @R004
CON
SET START                ; START
CON
MPS
AND START_OK             ; START OK
JMP @R006
MPP
LDB BUSY                 ; Busy
ANB MR20105              ; ｴﾘｱｾﾝｻ遮光検出
ANL
TMR @0 #50
CON
AND @T0
RES START                ; START
CON
JMP @R009
;位置決め開始完了
STG @R006
RES START                ; START
CON
MPS
ANB START_OK             ; START OK
JMP @R007
MPP
ANB MR20105              ; ｴﾘｱｾﾝｻ遮光検出
TMR @1 #50
CON
AND @T1
JMP @R009
;位置決め完了
STG @R007
MPS
LDB AXIS_ERR             ; Axis ERROR
AND MOVE_END             ; MOVE END
ANL
SET MOVE_END_CL          ; MOVE END CLEAR
CON
JMP @R008
MPP
AND AXIS_ERR             ; Axis ERROR
JMP @R009
STG @R008
MPS
LDB AXIS_ERR             ; Axis ERROR
ANB MOVE_END             ; MOVE END
ANL
RES MOVE_END_CL          ; MOVE END CLEAR
CON
JMP @R009
MPP
AND AXIS_ERR             ; Axis ERROR
JMP @R009
;完了Code 確認  正常完了は0
STG @R009
MPS
DW #999 @DM0             ; 位置決め完了Code
CON
UREAD @DM7 @DM26 @DM0 #1 ; UNIT_No.  位置決め完了Codeﾃﾞﾊﾞｲｽ修飾  位置決め完了Code
MRD
LD= @DM0 #0              ; 位置決め完了Code
ANB DRV_ALM              ; Driver ALARM
ANL
DW #20 P0                ; C_CODE
CON
JMP @R012                ; 終了処理
MRD
AND<> @DM0 #0            ; 位置決め完了Code
LDA @DM0                 ; 位置決め完了Code
CON
STA P0                   ; C_CODE
CON
JMP @R012                ; 終了処理
MPP
AND DRV_ALM              ; Driver ALARM
DW #24 P0                ; C_CODE
CON
JMP @R012                ; 終了処理
;終了処理
STG @R012                ; 終了処理
SET @R001                ; ﾏｸﾛ実行完了
CON
RES @R002                ; ﾏｸﾛ実行中
CON
ENDS
LD @R001                 ; ﾏｸﾛ実行完了
RES @R001                ; ﾏｸﾛ実行完了
CON
MEND
;出力
LD START                 ; START
OUT *Control:#0          ; 位置決め制御先頭ﾘﾚｰ
LD MOVE_END_CL           ; MOVE END CLEAR
OUT *Control:#2          ; 位置決め制御先頭ﾘﾚｰ
LD DRV_ALM_RES           ; Driver ALARM Reset
OUT *STATUS:#693         ; 位置決めSTATUSﾘﾚｰ
LD AXIS_ERR_CL           ; Axis ERROR CLEAR
OUT *STATUS:#640         ; 位置決めSTATUSﾘﾚｰ
END
ENDH
