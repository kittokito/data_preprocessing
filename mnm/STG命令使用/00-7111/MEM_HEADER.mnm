DEVICE:53
;MODULE:MEM_HEADER
;MODULE_TYPE:1
;SCRIPT_TYPE:
;★★★  MEM_HEAD_RES メモリーカード内の検査結果ファイルにタイトルを書き込む  ★★★
;★ ★ ★ MEM_HEAD_RES Write the title to the inspection result file in the memory card ★ ★ ★
;■ 引数説明
;  P1		: 書込みﾌｧｲﾙ名						[DMxxx,EMxxx等、文字列の格納ｴﾘｱ]
;
;  P7		: エラーフラグ						[MRxxx等]
;  P8		: エラー情報						[DMxxx,EMxxx等]
;■ Argument Description
;   P1: Written file name [DMxxx, EMxxx, etc., storage area of character string]
;
;   P7: Error flag [MRxxx etc.]
;   P8: Error information [DMxxx, EMxxx, etc.]
;■ 機能
;  ・このﾏｸﾛ内の@DM0 で指定されたCSVﾌｧｲﾙのﾃﾞｰﾀ内容を、P1 で指定したﾌｧｲﾙにｺﾋﾟｰする。
;
;  ・ﾒﾓﾘｰｶｰﾄﾞ内の@DM0 で指定されたCSVﾌｧｲﾙのﾃﾞｰﾀ内容を、P1 で指定したﾌｧｲﾙにﾃﾞｰﾀをｺﾋﾟｰする。
;    ﾌｫﾙﾀﾞｰが複数指定されている場合、全てのﾌｫﾙﾀﾞｰを作成する。
;       例. ﾌｫﾙﾀﾞ名P1:DATA\MODEL\RESULT\RESULT.CSV の場合
;          1.DATAﾌｫﾙﾀﾞを作成
;          2.DATAﾌｫﾙﾀﾞの中にMODELﾌｫﾙﾀﾞを作成
;          3.DATA\MODELﾌｫﾙﾀﾞの中にRESULTﾌｫﾙﾀﾞを作成
;          4.DATA\MODEL\RESULT\RESULT ﾌｧｲﾙに書込みを行う
;
;	  ※既にﾌｧｲﾙが存在する場合は、ｴﾗｰとする。
;
;  ・ｴﾗｰが発生した場合は、P7(ｴﾗｰﾌﾗｸﾞ) をセットし処理を終了する。
;  ・また、P8 にエラー情報コードを格納する。
;  
;■ Function
;  ? Copy the data contents of the CSV file specified by @ DM 0 in this macro to the file specified by P1.
;
;  ? Copy the data contents of the CSV file specified by @ DM 0 in the memory card to the file specified by P1.
;    When multiple folders are specified, create all the folders.
;       Example: Folder name P1: DATA \ MODEL \ RESULT \ RESULT.CSV
;          1. Create a DATA folder
;          2. Create a MODEL folder in the DATA folder
;          3. Create a RESULT folder in the DATA \ MODEL folder
;          4. Write to the DATA \ MODEL \ RESULT \ RESULT file
;
;* If the file already exists, it is an error.
;
;  ? If an error occurs, set P7 (error flag) and end the process.
;  Also, store error information code in P8.
;■ エラーフラグ(P7)をセットする条件
;  ・ﾒﾓﾘｰｶｰﾄﾞ命令が正しく実行されなかった場合。
;
;  ・P8にエラー情報(CM2390)を格納する。
;    ( 1〜9  : ﾒﾓﾘｰｶｰﾄﾞ命令ｴﾗｰｺｰﾄﾞ )
;      
;■ Conditions for setting error flag (P7)
;   ? The memory card instruction is not executed correctly.
;
;   Store error information (CM 2390) in P8.
;     (1 to 9: memory card instruction error code)
LDF @CR2008
RES P7                   ; Error relay
CON
DW #0 P8                 ; Error inform
CON
ZRES @MR000 @MR215
CON
SET @MR200
STG @MR200
ANB CR3214               ; mem card instr executing
FMOV #0 @DM0 #350
JMP @MR201
;<<ﾌｫﾙﾀﾞ作成>>
;<< Create folder >>
STG @MR201
ANP @MR100
RES @MR100
CON
JMP @MR202
;'ｺﾋﾟｰ先ﾌｫﾙﾀﾞ作成
;'Create destination folder
;@DM310 = SPLIT(P2.T,"\",@DM200.T,@DM220.T,@DM240.T,@DM260.T,@DM280.T) - 1
;
;@DM311 = 0
;
;SET(@MR100.b)
LDP @MR201
NCJ #1001
;'ｺﾋﾟｰ先ﾌｫﾙﾀﾞ作成
;
;'Create destination folder
;
;@DM310 = SPLIT(P2.T,"\",@DM200.T,@DM220.T,@DM240.T,@DM260.T,@DM280.T) - 1
;
LD CR2002                ; always on
ADRSET VM2 VM0
MOV #0 VM2
MOV.D VM0 @VM0
SMOV "\" *@VM0
LD CR2002                ; always on
LEN P2 @VM2              ; Copy pass
LEN *@VM0 @VM3
DW #0 @VM4
CON
DW #0 @VM5
CON
DW #0 @VM6
CON
DW #0 @VM7
LD CR2002                ; always on
DW #0 @DM200
CON
DW #0 @DM220
CON
DW #0 @DM240
CON
DW #0 @DM260
CON
DW #0 @DM280
FOR #5
LD CR2002                ; always on
INC @VM7
LD>= @VM4 @VM2
BREAK
LD>= @VM7 #5
MOV #65535 @VM5
CJ #2000
LD CR2002                ; always on
LDA @VM4
CON
ADD @VM3
CON
CMP @VM2
LD CR2011                ; positive result
MOV #65535 @VM5
LD CR2009                ; negative result
OR CR2010                ; 0 result
SFIND P2 *@VM0 @VM5 @VM4 ; Copy pass
LD CR2012                ; execution error
MOV #0 @VM7
BREAK
LABEL #2000
LD= @VM5 #65535
CAL- @VM2 @VM4 @VM6
LD= @VM5 #0
MOV #0 @VM6
LD> @VM5 #0
CAL- @VM5 @VM4 @VM6
LD> @VM6 #0
MPS
AND= @VM7 #1
MPS
AND> @VM6 #1999
MOV #1999 @VM6
MPP
SMID P2 @DM200 @VM4 @VM6 ; Copy pass
MRD
AND= @VM7 #2
MPS
AND> @VM6 #1999
MOV #1999 @VM6
MPP
SMID P2 @DM220 @VM4 @VM6 ; Copy pass
MRD
AND= @VM7 #3
MPS
AND> @VM6 #1999
MOV #1999 @VM6
MPP
SMID P2 @DM240 @VM4 @VM6 ; Copy pass
MRD
AND= @VM7 #4
MPS
AND> @VM6 #1999
MOV #1999 @VM6
MPP
SMID P2 @DM260 @VM4 @VM6 ; Copy pass
MPP
AND= @VM7 #5
MPS
AND> @VM6 #1999
MOV #1999 @VM6
MPP
SMID P2 @DM280 @VM4 @VM6 ; Copy pass
LD CR2012                ; execution error
MOV #0 @VM7
BREAK
LD= @VM5 #65535
BREAK
LD CR2002                ; always on
CAL+ @VM5 @VM3 @VM4
NEXT
LD CR2002                ; always on
LDA @VM7
CON
EXT
CON
SUB.L +1
CON
STA @DM310
;@DM311 = 0
;
LD CR2002                ; always on
MOV #0 @DM311
;SET(@MR100.b)
LD CR2002                ; always on
SET @MR100
LABEL #1001
;
STG @MR202
AND @MR101
RES @MR101
CON
JMP @MR203
;@DM150.T = @DM150.T + @DM200.T:(20*@DM311)
;
;SET(@MR101.b)
LDP @MR202
NCJ #1002
;@DM150.T = @DM150.T + @DM200.T:(20*@DM311)
;
LD CR2002                ; always on
LDA @DM311
CON
EXT
CON
MUL.L +20
CON
STA.L Z12
LD CR2002                ; always on
ADRSET VM2 VM0
MOV #0 VM2
MOV.D VM0 @VM8
SMOV @DM150 *@VM8
LD CR2002                ; always on
SADD *@VM8 @DM200:Z12 *@VM8
SMOV *@VM8 @DM150
;SET(@MR101.b)
LD CR2002                ; always on
SET @MR101
LABEL #1002
;
STG @MR203
ANP @MR000
MPS
ANB @MR001
JMP @MR204
MPP
AND @MR001
JMP @MR215
LDP @MR203
MMKDIR @DM150 @MR000
STG @MR204
@INC @DM311
MPS
AND>= @DM310 @DM311
SADD @DM150 "\" @DM150
JMP @MR202
MPP
AND< @DM310 @DM311
JMP @MR208
;<<ﾀｲﾄﾙｺﾋﾟｰ>>
;<< Title copy >>
;
STG @MR208
AND @MR100
RES @MR100
CON
JMP @MR209
;'ﾌｧｲﾙ名設定(ｺﾋﾟｰ元は引数で拡張子を含んでいるので、拡張子は付加しない)
;'File name setting (Copy source is argument with extension, so do not add extension)
;@DM0.T = P0.T							'ｺﾋﾟｰ元ﾌｧｲﾙ名/Source file name
;@DM50.T = P1.T + ".CSV"					'ｺﾋﾟｰ先ﾌｧｲﾙ名/Copy destination file name
;
;'ｺﾋﾟｰ形式設定
;'Copy format setting
;@DM110 = #1								'同名ﾌｧｲﾙがあった場合、ｴﾗｰ
;'If there is a file with the same name, an error
;
;SET(@MR100.b)
LDP @MR208
NCJ #1000
;'ﾌｧｲﾙ名設定(ｺﾋﾟｰ元は引数で拡張子を含んでいるので、拡張子は付加しない)
;
;'File name setting (Copy source is argument with extension, so do not add extension)
;
;@DM0.T = P0.T							'ｺﾋﾟｰ元ﾌｧｲﾙ名/Source file name
;
LD CR2002                ; always on
SMOV P0 @DM0             ; Copy source 
;@DM50.T = P1.T + ".CSV"					'ｺﾋﾟｰ先ﾌｧｲﾙ名/Copy destination file name
;
LD CR2002                ; always on
ADRSET VM2 VM0
MOV #0 VM2
MOV.D VM0 @VM10
SMOV P1 *@VM10           ; Copy destina
LD CR2002                ; always on
SADD *@VM10 ".CSV" *@VM10
SMOV *@VM10 @DM50
;'ｺﾋﾟｰ形式設定
;
;'Copy format setting
;
;@DM110 = #1								'同名ﾌｧｲﾙがあった場合、ｴﾗｰ
;
LD CR2002                ; always on
MOV #1 @DM110
;'If there is a file with the same name, an error
;
;SET(@MR100.b)
LD CR2002                ; always on
SET @MR100
LABEL #1000
;
STG @MR209
ANP @MR004
MPS
ANB @MR005
JMP @MR215
MPP
AND @MR005
MPS
AND<> CM2390 #4          ; mem card instr err code
SET P7                   ; Error relay
CON
JMP @MR215
MPP
AND= CM2390 #4           ; mem card instr err code
JMP @MR215
LDP @MR209
MCOPY @DM0 @DM50 @DM110 @MR004
;<<終了>>/end
;
STG @MR215
MPS
AND P7                   ; Error relay
MOV CM2390 P8            ; mem card instr err code  Error inform
MRD
ENDS
MPP
MEND
END
ENDH
