DEVICE:53
;MODULE:VAL_UT32_L20
;MODULE_TYPE:1
;SCRIPT_TYPE:
;★★★  GET_UT32_L20  KV-L21V 通信マクロを実行する  ★★★
;■ 使用条件
;  ・KV-L21V を使用して、通信ﾌﾟﾛﾄｺﾙが << Modbusﾏｽﾀﾓｰﾄﾞで動作している事 >>
;■ 引数説明
;  UR0/UM0 	: ユニット番号		            	[#1 - #48]
;  P0 		: パラメータ格納先					[DMxxx,EMxxx等]
;			:  Adrs+0 : ｽﾚｰﾌﾞ局番(1〜31)
;			:  Adrs+1 : 通信ﾀｲﾑｱｳﾄ(#1 - #999 ×100ms)
;  P1		: 受信データを格納するメモリー		[DMxxx,EMxxx等]
;  P2		: エラーフラグ   0:OK 1:Error		[MRxxx等]
;  P3		: エラー情報						[DMxxx,EMxxx等]
;
;■ 機能
;  ・P0の(adr+0)で指定したチャンネル番号(1〜31)を使用する。
;  
;  ・ﾃﾞｨｼﾞﾀﾙ指示調節計(YOKOGAWA UT32A)から圧力データを読出し指定メモリーエリアに格納する
;    <P1> 圧力ﾃﾞｰﾀの格納ｴﾘｱ
;   
;■ エラーフラグ(P3)をセットする条件
;  ・P0(Adr+0〜3)が範囲外で呼ばれたとき。
;  ・通信エラー（ﾚｽﾎﾟﾝｽ異常、受信タイムアウト）が発生した時。
;  ・通信マクロデータが異常な時。
;  ・P3にエラー情報を格納する。
;		1:ﾃﾞｰﾀ数範囲外(1-999)
;    	2:受信ﾃﾞｰﾀ異常(ﾚｰｽﾎﾟﾝｽ2)
;    	3:通信ｴﾗｰ
;    	4:通信ﾀｲﾑｱｳﾄ
;    	5:通信ﾏｸﾛｴﾗｰ
;<<  初期化処理  >>
;<<Initialization processing>>
LD @CR2008
ZRES @MR000 @MR015
CON
RES P2                   ; ｴﾗｰﾌﾗｸﾞ
;
;adrset( P0, @DM40.D )
;
;@DM4 = *@DM40			'通信ﾁｬﾝﾈﾙ  	Adrs +0
;
;adradd( #1, @DM40.D )
;@DM24.D = *@DM40		'通信ﾀｲﾑｱｳﾄ		Adrs +1
;
LD @CR2008
NCJ #1000
;adrset( P0, @DM40.D )
;
LD CR2002                ; always on
ADRSET P0 @DM40          ; ﾊﾟﾗﾒｰﾀ格納先
;@DM4 = *@DM40			'通信ﾁｬﾝﾈﾙ  	Adrs +0
;
LD CR2002                ; always on
MOV *@DM40 @DM4
;adradd( #1, @DM40.D )
;
LD CR2002                ; always on
ADRADD.S +1 @DM40
;@DM24.D = *@DM40		'通信ﾀｲﾑｱｳﾄ		Adrs +1
;
LD CR2002                ; always on
LDA *@DM40
CON
EXT
CON
STA.D @DM24
LABEL #1000
;
;'ｽﾚｰﾌﾞ局番を設定する
;	adrset(UM0:#601,@EM50.D)		'ｽﾚｰﾌﾞ局番	
;'	*@EM50.D=@DM4
;	
;	adrset(UM0:#602,@EM52.D)		'ﾌｧﾝｸｼｮﾝｺｰﾄﾞ	
;	*@EM52.D=3
;	
;	adrset(UM0:#606,@EM54.D)		'ﾃﾞｰﾀ格納単位	
;	*@EM54.D=0
;	
;	adrset(UM0:#608,@EM56.D)		'読出し点数
;	*@EM56.D=1
;'ｴﾗｰｺｰﾄﾞ格納先を設定する	
;	adrset(UM0:#900,@EM58.D)		'ｴﾗｰｺｰﾄﾞ
LD @CR2008
NCJ #1001
;'ｽﾚｰﾌﾞ局番を設定する
;
;	adrset(UM0:#601,@EM50.D)		'ｽﾚｰﾌﾞ局番	
;
LD CR2002                ; always on
ADRSET UM0:#601 @EM50    ; ﾕﾆｯﾄ番号
;'	*@EM50.D=@DM4
;
;	adrset(UM0:#602,@EM52.D)		'ﾌｧﾝｸｼｮﾝｺｰﾄﾞ	
;
LD CR2002                ; always on
ADRSET UM0:#602 @EM52    ; ﾕﾆｯﾄ番号
;	*@EM52.D=3
;
LD CR2002                ; always on
MOV.D #3 *@EM52
;	adrset(UM0:#606,@EM54.D)		'ﾃﾞｰﾀ格納単位	
;
LD CR2002                ; always on
ADRSET UM0:#606 @EM54    ; ﾕﾆｯﾄ番号
;	*@EM54.D=0
;
LD CR2002                ; always on
MOV.D #0 *@EM54
;	adrset(UM0:#608,@EM56.D)		'読出し点数
;
LD CR2002                ; always on
ADRSET UM0:#608 @EM56    ; ﾕﾆｯﾄ番号
;	*@EM56.D=1
;
LD CR2002                ; always on
MOV.D #1 *@EM56
;'ｴﾗｰｺｰﾄﾞ格納先を設定する	
;
;	adrset(UM0:#900,@EM58.D)		'ｴﾗｰｺｰﾄﾞ
LD CR2002                ; always on
ADRSET UM0:#900 @EM58    ; ﾕﾆｯﾄ番号
LABEL #1001
;
;'通信ﾀｲﾑｱｳﾄ時間の有効範囲を確認する
;if @DM24.D < #1 or @DM24.D > #999 then	'通信ﾀｲﾑｱｳﾄ時間の有効範囲を確認
;	set( P2.B )							'範囲外ならｴﾗｰﾌﾗｸﾞをONする
;	P3 = 1								'ｺﾏﾝﾄﾞ範囲外
;end if
;
LD @CR2008
NCJ #1002
;'通信ﾀｲﾑｱｳﾄ時間の有効範囲を確認する
;
;if @DM24.D < #1 or @DM24.D > #999 then	'通信ﾀｲﾑｱｳﾄ時間の有効範囲を確認
;
LD<.D @DM24 #1
OUT @VB00
LD>.D @DM24 #999
OR @VB00
NCJ #2000
;	set( P2.B )							'範囲外ならｴﾗｰﾌﾗｸﾞをONする
;
LD CR2002                ; always on
SET P2                   ; ｴﾗｰﾌﾗｸﾞ
;	P3 = 1								'ｺﾏﾝﾄﾞ範囲外
;
LD CR2002                ; always on
MOV #1 P3                ; ｴﾗｰ情報
;end if
;
LABEL #2000
LABEL #1002
;
;'通信ﾏｸﾛに使用するｱﾄﾞﾚｽを設定する
;
;	adrset(UR0:#33,@EM0.D)		'ｺﾏﾝﾄﾞ送信要求		+1401
;	adrset(UR0:#49,@EM2.D)		'実行完了		    +1501
;	adrset(UR0:#50,@EM4.D)		'実行失敗           +1502
;	adrset(UR0:#51,@EM8.D)		'@実行中        	+1503
LD @CR2008
ANB P3                   ; ｴﾗｰ情報
NCJ #1003
;'通信ﾏｸﾛに使用するｱﾄﾞﾚｽを設定する
;
;	adrset(UR0:#33,@EM0.D)		'ｺﾏﾝﾄﾞ送信要求		+1401
;
LD CR2002                ; always on
ADRSET UR0:#33 @EM0      ; ﾕﾆｯﾄ番号
;	adrset(UR0:#49,@EM2.D)		'実行完了		    +1501
;
LD CR2002                ; always on
ADRSET UR0:#49 @EM2      ; ﾕﾆｯﾄ番号
;	adrset(UR0:#50,@EM4.D)		'実行失敗           +1502
;
LD CR2002                ; always on
ADRSET UR0:#50 @EM4      ; ﾕﾆｯﾄ番号
;	adrset(UR0:#51,@EM8.D)		'@実行中        	+1503
LD CR2002                ; always on
ADRSET UR0:#51 @EM8      ; ﾕﾆｯﾄ番号
LABEL #1003
;
;'ｺﾏﾝﾄﾞの有効範囲を確認する
;'ｺﾏﾝﾄﾞ毎に通信ﾏｸﾛ用のﾘﾚｰを設定する
;
;@DM0 = 1								'ﾏｸﾛｺﾏﾝﾄﾞ番号設定
;
;if @DM0 < #1 or @DM0 > #99 then			'ｺﾏﾝﾄﾞの有効範囲を確認
;	set( P2.B )							'範囲外ならｴﾗｰﾌﾗｸﾞをONする
;	P3 = 1								'ｺﾏﾝﾄﾞ範囲外
;else
;	@DM0 = @DM0 -1
;	adradd( @DM0, @EM0.D )				'ｺﾏﾝﾄﾞ送信要求
;	adradd( @DM0, @EM2.D )				'実行完了
;	adradd( ( @DM0 * #1 ), @EM4.D )		'実行失敗
;	adradd( @DM0, @EM8.D )				'実行中
;end if
;
LD @CR2008
NCJ #1004
;'ｺﾏﾝﾄﾞの有効範囲を確認する
;
;'ｺﾏﾝﾄﾞ毎に通信ﾏｸﾛ用のﾘﾚｰを設定する
;
;@DM0 = 1								'ﾏｸﾛｺﾏﾝﾄﾞ番号設定
;
LD CR2002                ; always on
MOV #1 @DM0
;if @DM0 < #1 or @DM0 > #99 then			'ｺﾏﾝﾄﾞの有効範囲を確認
;
LD< @DM0 #1
OUT @VB01
LD> @DM0 #99
OR @VB01
NCJ #2001
;	set( P2.B )							'範囲外ならｴﾗｰﾌﾗｸﾞをONする
;
LD CR2002                ; always on
SET P2                   ; ｴﾗｰﾌﾗｸﾞ
;	P3 = 1								'ｺﾏﾝﾄﾞ範囲外
;
LD CR2002                ; always on
MOV #1 P3                ; ｴﾗｰ情報
;else
;
LD CR2002                ; always on
CJ #2002
LABEL #2001
;	@DM0 = @DM0 -1
;
LD CR2002                ; always on
LDA @DM0
CON
EXT
CON
SUB.L +1
CON
STA @DM0
;	adradd( @DM0, @EM0.D )				'ｺﾏﾝﾄﾞ送信要求
;
LD CR2002                ; always on
ADRADD.S @DM0 @EM0
;	adradd( @DM0, @EM2.D )				'実行完了
;
LD CR2002                ; always on
ADRADD.S @DM0 @EM2
;	adradd( ( @DM0 * #1 ), @EM4.D )		'実行失敗
;
LD CR2002                ; always on
LDA @DM0
CON
EXT
CON
MUL.L +1
CON
STA.L @VM0
ADRADD.L @VM0 @EM4
;	adradd( @DM0, @EM8.D )				'実行中
;
LD CR2002                ; always on
ADRADD.S @DM0 @EM8
;end if
;
LABEL #2002
LABEL #1004
;
;'送受信ﾊﾟﾗﾒｰﾀを必要としないｺﾏﾝﾄﾞ用にﾀﾞﾐｰｴﾘｱを設定する
;@EM20=0
;@EM21=0
;adrset( @EM20,@EM12.D)
;adrset( @EM21,@EM14.D)
;
;'送受信ﾊﾟﾗﾒｰﾀを必要とするｺﾏﾝﾄﾞは、正式な格納ｴﾘｱを再設定する
;
;'圧力読取りｺﾏﾝﾄﾞ用					
;	adrset(UM0:#607,@EM12.D)
;	adrset(UM0:#911,@EM14.D)
;
;@DM2=13							'受信ﾃﾞｰﾀ数(ﾜｰﾄﾞ単位)
;
LD @CR2008
NCJ #1005
;'送受信ﾊﾟﾗﾒｰﾀを必要としないｺﾏﾝﾄﾞ用にﾀﾞﾐｰｴﾘｱを設定する
;
;@EM20=0
;
LD CR2002                ; always on
MOV #0 @EM20
;@EM21=0
;
LD CR2002                ; always on
MOV #0 @EM21
;adrset( @EM20,@EM12.D)
;
LD CR2002                ; always on
ADRSET @EM20 @EM12
;adrset( @EM21,@EM14.D)
;
LD CR2002                ; always on
ADRSET @EM21 @EM14
;'送受信ﾊﾟﾗﾒｰﾀを必要とするｺﾏﾝﾄﾞは、正式な格納ｴﾘｱを再設定する
;
;'圧力読取りｺﾏﾝﾄﾞ用					
;
;	adrset(UM0:#607,@EM12.D)
;
LD CR2002                ; always on
ADRSET UM0:#607 @EM12    ; ﾕﾆｯﾄ番号
;	adrset(UM0:#911,@EM14.D)
;
LD CR2002                ; always on
ADRSET UM0:#911 @EM14    ; ﾕﾆｯﾄ番号
;@DM2=13							'受信ﾃﾞｰﾀ数(ﾜｰﾄﾞ単位)
;
LD CR2002                ; always on
MOV #13 @DM2
LABEL #1005
;
;'ﾃﾞｨｼﾞﾀﾙ指示調節計に圧力値の読取りｺﾏﾝﾄﾞを設定する
;@DM10 = $07D2
;
;'読取りｺﾏﾝﾄﾞを送信ｴﾘｱに設定する
;bmov( @DM10,*@EM12,1 )
;
;'ﾃﾞｨｼﾞﾀﾙ指示調節計から圧力値を格納するｱﾄﾞﾚｽを設定する
;adrset( P1, @EM20.D )		'ﾃﾞｰﾀ 格納先ｱﾄﾞﾚｽを設定
;'adradd( #1, @EM20.D )
;
;adrset( P1,@EM22.D )		'ﾃﾞｰﾀ数 格納先ｱﾄﾞﾚｽを設定
;*@EM22.S = #0
;
;set( @MR0.B )				'処理開始
;
LD @CR2008
NCJ #1006
;'ﾃﾞｨｼﾞﾀﾙ指示調節計に圧力値の読取りｺﾏﾝﾄﾞを設定する
;
;@DM10 = $07D2
;
LD CR2002                ; always on
MOV $07D2 @DM10
;'読取りｺﾏﾝﾄﾞを送信ｴﾘｱに設定する
;
;bmov( @DM10,*@EM12,1 )
;
LD CR2002                ; always on
BMOV @DM10 *@EM12 #1
;'ﾃﾞｨｼﾞﾀﾙ指示調節計から圧力値を格納するｱﾄﾞﾚｽを設定する
;
;adrset( P1, @EM20.D )		'ﾃﾞｰﾀ 格納先ｱﾄﾞﾚｽを設定
;
LD CR2002                ; always on
ADRSET P1 @EM20          ; 受信ﾃﾞｰﾀ格先
;'adradd( #1, @EM20.D )
;
;adrset( P1,@EM22.D )		'ﾃﾞｰﾀ数 格納先ｱﾄﾞﾚｽを設定
;
LD CR2002                ; always on
ADRSET P1 @EM22          ; 受信ﾃﾞｰﾀ格先
;*@EM22.S = #0
;
LD CR2002                ; always on
MOV.S +0 *@EM22
;set( @MR0.B )				'処理開始
;
LD CR2002                ; always on
SET @MR000
LABEL #1006
;
;<<  通信マクロを起動して処理する  >>
;<<Start communication macros and process them>>
STG @MR000
AND= TM460 #0
MOV P0 TM460             ; ﾊﾟﾗﾒｰﾀ格納先
MOV P0 *@EM50            ; ﾊﾟﾗﾒｰﾀ格納先
JMP @MR101
STG @MR101
MPS
AND= TM460 *@EM50
JMP @MR001
MPP
AND<> TM460 *@EM50
JMP @MR000
STG @MR001
SET *@EM0
CON
JMP @MR002
STG @MR002
MPS
LDP *@EM2
ANB *@EM8
ANB *@EM4
ANL
DW #0 P3                 ; ｴﾗｰ情報
CON
MOV.S *@EM14 *@EM20
@INC *@EM22
RES *@EM0
JMP @MR003
MRD
AND *@EM4
MPS
DW #0 TM460
CON
RES *@EM0
CON
SET P2                   ; ｴﾗｰﾌﾗｸﾞ
CON
JMP @MR011
MPP
MOV *@EM58 P3            ; ｴﾗｰ情報
MPP
AND<> @DM24 #0
TMR @2 @DM24
CON
AND @T2
DW #0 TM460
CON
DW #4 P3                 ; ｴﾗｰ情報
CON
RES *@EM0
CON
SET P2                   ; ｴﾗｰﾌﾗｸﾞ
CON
JMP @MR011
STG @MR003
ANB *@EM0
ANB *@EM2
ANB *@EM8
DW #0 TM460
CON
JMP @MR011
;<<  受信データ処理を終了する  >>
;<<End reception data processing>>
STG @MR011
SET P4                   ; 実行完了
CON
ENDS
MEND
END
ENDH
