DEVICE:53
;MODULE:IAI_CON_MOVE
;MODULE_TYPE:1
;SCRIPT_TYPE:
;OneSystem SupportMacro
;
;-----------------------------------------
;Macro Name 	: 	IAI_CON_MOVE
;Macro Type	:	Self Holding
;Function	:	IAI CON系直値移動ﾏｸﾛ
;-----------------------------------------
;引数：
;	P0  =	移動ﾎﾟｼﾞｼｮﾝ格納DM先頭		DM番号で指定	P0 = Leading Address of Point data storage
;	P1	=	位置決め完了幅格納DM先頭	DM番号で指定	P1 = Leading Address of COIN data storage
;	P2  =   移動速度格納DM先頭			DM番号で指定	P2 = Leading Address of Velocity data storage
;	P3	=	RB入力先頭番地				DM番号で指定	P3 = Input Leading Address for RB
;	P4  =	RB出力先頭番地				DM番号で指定	P4 = Output Leading Address for RB
;	P5  =   完了フラグ
;	P6  =   完了コード									P5 = Macro Complete Code
;			#20 	= 正常終了								#20 = No Error
;			#21 	= RB応答なし							#21 = Non Responce
;			#22 	= ｽﾃｰﾀｽ異常								#22 = Status Abnormal
;			#1-16	= RBｱﾗｰﾑ(取説PIOｱﾗｰﾑｺｰﾄﾞ参照)			#1-16 = RB Alarm(Refer the Controller Manual)
;	P7  =   非常停止ﾌﾗｸﾞ                            	P7 = Emergency Stop Flag
;	V1  =   ﾀｲﾑｱｳﾄ設定                              	V1 = Time out Value
;機能：
;	ACON/PCON/SCON用簡易直値移動指令ﾏｸﾛ/ Robot Move Macro for Numerical Move Mode
;初期化　/ Initialize
LD @CR2008
DW #0 P6                 ; C_CODE
CON
SET @MR000
;RBｽﾃｰﾀｽﾓﾆﾀｰ / Status Monitoring
BLD P3:#7 #3             ; RB_IN
OUT @MR014
BLD P3:#7 #1             ; RB_IN
BAND P3:#7 #4            ; RB_IN
BANB P3:#7 #8            ; RB_IN
BAND P3:#7 #14           ; RB_IN
BANB P3:#7 #15           ; RB_IN
OUT @MR001
;ｱﾗｰﾑ発生
LDP @MR014
MOV P3:#6 P6             ; RB_IN  C_CODE
ZRES @MR000 @MR015
CON
SET P5                   ; END_FLAG
;RB状態ﾁｪｯｸ /　Robot Status Check
STG @MR000
MPS
LD @MR001
BANB P3:#7 #2            ; RB_IN
ANL
JMP @MR002
MPP
ANB @MR001
TMR @0 V1                ; TimeOut
CON
AND @T0
AND CR2003               ; 常時OFF
DW #22 P6                ; C_CODE
CON
JMP @MR015
;P4.L   = P0.L   '目標位置ﾃﾞｰﾀ
;P4.D:2 = P1.D   '位置決め完了幅
;P4.U:4 = P2.U   '速度ﾃﾞｰﾀ
;P4.U:5 = 10     '加速度0.1G固定
;SET(@MR003)     '計算完了ﾌﾗｸﾞ
;
LD @MR002
NCJ #1000
;P4.L   = P0.L   '目標位置ﾃﾞｰﾀ
;
LD CR2002                ; 常時ON
MOV.L P0 P4              ; POS_DATA  RB_OUT
;P4.D:2 = P1.D   '位置決め完了幅
;
LD CR2002                ; 常時ON
MOV.D P1 P4:#2           ; COIN_DATA  RB_OUT
;P4.U:4 = P2.U   '速度ﾃﾞｰﾀ
;
LD CR2002                ; 常時ON
MOV P2 P4:#4             ; VEL_DATA  RB_OUT
;P4.U:5 = 10     '加速度0.1G固定
;
LD CR2002                ; 常時ON
MOV #10 P4:#5            ; RB_OUT
;SET(@MR003)     '計算完了ﾌﾗｸﾞ
;
LD CR2002                ; 常時ON
SET @MR003
LABEL #1000
;
STG @MR002
AND @MR003
TMS @1 #5
CON
AND @T1
BSET P4:#7 #0            ; RB_OUT
CON
RES @MR003
CON
JMP @MR004
STG @MR004
MPS
BANB P3:#7 #0            ; RB_IN
BRES P4:#7 #0            ; RB_OUT
CON
JMP @MR005
MPP
BAND P3:#7 #0            ; RB_IN
TMR @2 V1                ; TimeOut
CON
AND @T2
AND CR2003               ; 常時OFF
BRES P4:#7 #0            ; RB_OUT
CON
DW #21 P6                ; C_CODE
CON
JMP @MR015
STG @MR005
MPS
BLDB P3:#7 #2            ; RB_IN
BAND P3:#7 #0            ; RB_IN
ANL
TMH @4 #10
CON
AND @T4
JMP @MR006
MPP
BANB P3:#7 #0            ; RB_IN
TMR @3 V1                ; TimeOut
CON
AND @T3
AND CR2003               ; 常時OFF
BRES P4:#7 #0            ; RB_OUT
CON
DW #21 P6                ; C_CODE
CON
JMP @MR015
STG @MR006
DW #20 P6                ; C_CODE
CON
JMP @MR015
STG @MR015
SET P5                   ; END_FLAG
CON
ENDS
;終了処理
LD P7                    ; EMG_FLAG
ZRES @MR000 @MR015
LD P5                    ; END_FLAG
OR P7                    ; EMG_FLAG
MEND
END
ENDH
