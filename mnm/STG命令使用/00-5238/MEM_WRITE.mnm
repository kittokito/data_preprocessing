DEVICE:52
;MODULE:MEM_WRITE
;MODULE_TYPE:1
;SCRIPT_TYPE:
;★★★　MEM_WRITE メモリーカードにデータを書き込む　★★★
;■ 引数説明
;  P0		: 書込みﾌｧｲﾙが存在するﾌｫﾙﾀﾞｰ名		[DMxxx,EMxxx等、文字列の格納ｴﾘｱ]
;			:  　5階層まで100文字以内
;  P1		: 書込みﾌｧｲﾙ名						[DMxxx,EMxxx等、文字列の格納ｴﾘｱ]
;
;　P2		: 保存形式							[DMxxx,EMxxx等]
;			:  0,1:16bit/32bit BINﾃﾞｰﾀ   2,3:16bit/32bit HEXﾃﾞｰﾀ
;			:  4,5:16bit/32bit 符号なしﾊﾞｲﾅﾘｰﾃﾞｰﾀ
;			:  6,7:16bit/32bit 符号付きﾊﾞｲﾅﾘｰﾃﾞｰﾀ
;			:  8  :ｱｽｷｰ文字列ﾃﾞｰﾀ
;			:  9  :浮動小数点ﾃﾞｰﾀ
;
;　P3		: 書込みﾓｰﾄﾞ						[DMxxx,EMxxx等]
;			:  0  :追加書込み
;			:  1  :新規書込み
;
;　P4		: 行末処理							[DMxxx,EMxxx等]
;			:  0  :行末にｶﾝﾏを書込み
;			:  1  :行末に改行(CRLF)ｺｰﾄﾞを書込み
;
;　P5		: 書込みﾃﾞｰﾀ格納ｴﾘｱ					[DMxxx,EMxxx等]
;　P6		: 書込みﾃﾞｰﾀ数						[DMxxx,EMxxx等]
;
;  P7		: エラーフラグ						[MRxxx等]
;　P8		: エラー情報						[DMxxx,EMxxx等]
;■ 機能
;　・P5 で指定したﾃﾞｰﾀｴﾘｱの内容を、P6 で指定したﾃﾞｰﾀ数分、ﾒﾓﾘｰｶｰﾄﾞに書込みを行う。
;
;　・ﾒﾓﾘｰｶｰﾄﾞ内に、P0 で指定された書込みﾌｫﾙﾀﾞｰを作成し、その中に、P1 で指定したﾌｧｲﾙにデータを保存する。
;　　ﾌｫﾙﾀﾞｰが複数指定されている場合、全てのﾌｫﾙﾀﾞｰを作成する。
;　　ﾌｫﾙﾀﾞｰは５階層まで作成可能。1ﾌｫﾙﾀﾞｰ当たりの最大文字数は半角20文字以内とする。
;　　　例. ﾌｫﾙﾀﾞｰ名P0:DATA\WORK1\PARA で、ﾌｧｲﾙ名P1 : MesData の場合
;　　　　　1.DATAﾌｫﾙﾀﾞｰを作成
;　　　　　2.DATAﾌｫﾙﾀﾞｰの中にWORK1ﾌｫﾙﾀﾞｰを作成
;　　　　　3.DATA\WORK1ﾌｫﾙﾀﾞｰの中にPARAﾌｫﾙﾀﾞｰを作成
;　　　　　4.DATA\WORK1\PARA\MesData ﾌｧｲﾙに書込みを行う
;
;　　　※既にフォルダーが存在する場合は、フォルダーは作成しない。
;
;　・書込みデータは、P2 で指定した保存形式で書き込まれる。
;　・また、P3 で書込みﾓｰﾄﾞを指定し、P4 で行末処理を指定する。
;
;　・エラーが発生した場合は、P7 にエラーフラグをセットし処理を終了する。
;　・また、P8 にエラー情報コードを格納する。
;　
;■ エラーフラグ(P7)をセットする条件
;  ・ﾒﾓﾘｰｶｰﾄﾞ命令が正しく実行されなかった場合。
;
;  ・P8にエラー情報を格納する。
;  　( 1〜9  : ﾒﾓﾘｰｶｰﾄﾞ命令ｴﾗｰｺｰﾄﾞ )
;  　  
;<<　初期化処理　>>
LD @CR2008
RES P7                   ; ｴﾗｰﾘﾚｰ
CON
DW #0 P8                 ; ｴﾗｰ情報
CON
ZRES @DM0 @DM100         ; 検索開始位置  ﾌｫﾙﾀﾞｰ+ﾌｧｲﾙ名
CON
ZRES @EM0 @EM100         ; ﾌｫﾙﾀﾞｰ名1 格納ｴﾘｱ
CON
ZRES @MR000 @MR215
LDF @CR2008
SET @MR000
;'フォルダー名　定義(ルート)
;
;'ﾌｫﾙﾀﾞｰ名の格納ｴﾘｱ
;adrset( @EM0,@DM10.D )
;
;@DM0 = 0	'開始位置
;@DM1 = 0	'検索位置
;@DM2 = 0	'ﾌｫﾙﾀﾞｰ数
;
;do
;	@DM1 = instr( @DM0,P0.T,"\" )
;	if @DM1 <> $FFFF then
;		if @DM1 < len( P0.T ) then
;			*@DM10.T = left( P0.T,@DM1 )
;
;			@DM2 += 1
;			adradd( #20,@DM10.D )
;
;			@DM0 = @DM1 + 1
;		end if
;	else
;		*@DM10.T = P0.T
;		@DM2 += 1
;	end if
;
;until( @DM1 = $FFFF )
;
;'ﾌｫﾙﾀﾞｰ名の格納ｴﾘｱ
;adrset( @EM0,@DM10.D )
;
;'処理開始
;RES( @MR0.B )
;SET( @MR1.B )
;
LD @MR000
ANB @MR001
NCJ #1001
;'フォルダー名　定義(ルート)
;
;'ﾌｫﾙﾀﾞｰ名の格納ｴﾘｱ
;
;adrset( @EM0,@DM10.D )
;
LD CR2002                ; 常時ON
ADRSET @EM0 @DM10        ; ﾌｫﾙﾀﾞｰ名1 格納ｴﾘｱ  ﾌｫﾙﾀﾞｰ名格納先ｱﾄﾞﾚｽ
;@DM0 = 0	'開始位置
;
LD CR2002                ; 常時ON
MOV #0 @DM0              ; 検索開始位置
;@DM1 = 0	'検索位置
;
LD CR2002                ; 常時ON
MOV #0 @DM1              ; 検索位置
;@DM2 = 0	'ﾌｫﾙﾀﾞｰ数
;
LD CR2002                ; 常時ON
MOV #0 @DM2              ; ﾌｫﾙﾀﾞｰ数
;do
;
LABEL #2000
;	@DM1 = instr( @DM0,P0.T,"\" )
;
LD CR2002                ; 常時ON
ADRSET VM2 VM0
MOV #0 VM2
MOV.D VM0 @VM0
SMOV "\" *@VM0
LD CR2002                ; 常時ON
MOV #0 @VM2
SFIND P0 *@VM0 @VM2 @DM0 ; ﾌｫﾙﾀﾞｰ名  検索開始位置
LD CR2002                ; 常時ON
MOV @VM2 @DM1            ; 検索位置
;	if @DM1 <> $FFFF then
;
LD<> @DM1 $FFFF          ; 検索位置
NCJ #2001
;		if @DM1 < len( P0.T ) then
;
LD CR2002                ; 常時ON
MOV #0 @VM3
LEN P0 @VM3              ; ﾌｫﾙﾀﾞｰ名
LD< @DM1 @VM3            ; 検索位置
NCJ #2002
;			*@DM10.T = left( P0.T,@DM1 )
;
LD CR2002                ; 常時ON
ADRSET VM2 VM0
MOV #0 VM2
MOV.D VM0 @VM4
LD CR2002                ; 常時ON
SLEFT P0 *@VM4 @DM1      ; ﾌｫﾙﾀﾞｰ名  検索位置
LD CR2002                ; 常時ON
SMOV *@VM4 *@DM10        ; ﾌｫﾙﾀﾞｰ名格納先ｱﾄﾞﾚｽ
;			@DM2 += 1
;
LD CR2002                ; 常時ON
INC @DM2                 ; ﾌｫﾙﾀﾞｰ数
;			adradd( #20,@DM10.D )
;
LD CR2002                ; 常時ON
ADRADD.S +20 @DM10       ; ﾌｫﾙﾀﾞｰ名格納先ｱﾄﾞﾚｽ
;			@DM0 = @DM1 + 1
;
;;Warning[1103]: "=": (符号付き32ビット整数型->符号無し16ビット整数型) 代入によりデータが欠落する可能性があります。
LD CR2002                ; 常時ON
LDA @DM1                 ; 検索位置
CON
EXT
CON
ADD.L +1
CON
STA @DM0                 ; 検索開始位置
;		end if
;
LABEL #2002
;	else
;
LD CR2002                ; 常時ON
CJ #2003
LABEL #2001
;		*@DM10.T = P0.T
;
LD CR2002                ; 常時ON
SMOV P0 *@DM10           ; ﾌｫﾙﾀﾞｰ名  ﾌｫﾙﾀﾞｰ名格納先ｱﾄﾞﾚｽ
;		@DM2 += 1
;
LD CR2002                ; 常時ON
INC @DM2                 ; ﾌｫﾙﾀﾞｰ数
;	end if
;
LABEL #2003
;until( @DM1 = $FFFF )
;
LD= @DM1 $FFFF           ; 検索位置
CJ #2004
LD CR2002                ; 常時ON
CJ #2000
LABEL #2004
;'ﾌｫﾙﾀﾞｰ名の格納ｴﾘｱ
;
;adrset( @EM0,@DM10.D )
;
LD CR2002                ; 常時ON
ADRSET @EM0 @DM10        ; ﾌｫﾙﾀﾞｰ名1 格納ｴﾘｱ  ﾌｫﾙﾀﾞｰ名格納先ｱﾄﾞﾚｽ
;'処理開始
;
;RES( @MR0.B )
;
LD CR2002                ; 常時ON
RES @MR000
;SET( @MR1.B )
;
LD CR2002                ; 常時ON
SET @MR001
LABEL #1001
;
;
;'フォルダー名＋ファイル名　定義(ルート)
;@DM100.T = P0.T + "\" + P1.T
;
;'<< 書込みﾓｰﾄﾞの設定 >>
;
;'保存形式
;@DM20 = P2			'保存形式  ：0,1:Bin 2〜9:CSVｶﾝﾏ区切り
;
;'書込みﾓｰﾄﾞ
;if P3 = 0 then
;	@DM21 = 0		'追加モード
;else
;	@DM21 = 3		'新規モード
;end if
;
;'行末処理
;if P4 = 0 then
;	@DM22 = 0		'末尾にｶﾝﾏを書込む
;else
;	@DM22 = 1		'末尾にCRLFｺｰﾄﾞを書込む
;end if
;
;'書込みﾃﾞｰﾀ格納ｴﾘｱ設定
;adrset( P5,@DM30.D )
;
;'書込みﾃﾞｰﾀ数　設定
;@DM26 = P6
;
;'処理開始
;RES( @MR1.B )
;SET( @MR100.B )
;
;
LD @MR001
ANB @MR100
NCJ #1000
;'フォルダー名＋ファイル名　定義(ルート)
;
;@DM100.T = P0.T + "\" + P1.T
;
LD CR2002                ; 常時ON
ADRSET VM2 VM0
MOV #0 VM2
MOV.D VM0 @VM6
SMOV P0 *@VM6            ; ﾌｫﾙﾀﾞｰ名
LD CR2002                ; 常時ON
SADD *@VM6 "\" *@VM6
SADD *@VM6 P1 *@VM6      ; ﾌｧｲﾙ名
SMOV *@VM6 @DM100        ; ﾌｫﾙﾀﾞｰ+ﾌｧｲﾙ名
;'<< 書込みﾓｰﾄﾞの設定 >>
;
;'保存形式
;
;@DM20 = P2			'保存形式  ：0,1:Bin 2〜9:CSVｶﾝﾏ区切り
;
LD CR2002                ; 常時ON
MOV P2 @DM20             ; 保存形式  保存形式の設定
;'書込みﾓｰﾄﾞ
;
;if P3 = 0 then
;
LD= P3 #0                ; 書込みﾓｰﾄﾞ
NCJ #2005
;	@DM21 = 0		'追加モード
;
LD CR2002                ; 常時ON
MOV #0 @DM21             ; 書込みﾓｰﾄﾞ設定
;else
;
LD CR2002                ; 常時ON
CJ #2006
LABEL #2005
;	@DM21 = 3		'新規モード
;
LD CR2002                ; 常時ON
MOV #3 @DM21             ; 書込みﾓｰﾄﾞ設定
;end if
;
LABEL #2006
;'行末処理
;
;if P4 = 0 then
;
LD= P4 #0                ; 行末処理
NCJ #2007
;	@DM22 = 0		'末尾にｶﾝﾏを書込む
;
LD CR2002                ; 常時ON
MOV #0 @DM22             ; ｵﾌﾟｼｮﾝの設定
;else
;
LD CR2002                ; 常時ON
CJ #2008
LABEL #2007
;	@DM22 = 1		'末尾にCRLFｺｰﾄﾞを書込む
;
LD CR2002                ; 常時ON
MOV #1 @DM22             ; ｵﾌﾟｼｮﾝの設定
;end if
;
LABEL #2008
;'書込みﾃﾞｰﾀ格納ｴﾘｱ設定
;
;adrset( P5,@DM30.D )
;
LD CR2002                ; 常時ON
ADRSET P5 @DM30          ; ﾃﾞｰﾀ格納ｴﾘｱ  書込みﾃﾞｰﾀ格納ｴﾘｱ
;'書込みﾃﾞｰﾀ数　設定
;
;@DM26 = P6
;
LD CR2002                ; 常時ON
MOV P6 @DM26             ; 書込みﾃﾞｰﾀ数  書込みﾃﾞｰﾀ数
;'処理開始
;
;RES( @MR1.B )
;
LD CR2002                ; 常時ON
RES @MR001
;SET( @MR100.B )
;
LD CR2002                ; 常時ON
SET @MR100
LABEL #1000
;
;<<　ﾒﾓﾘｶｰﾄﾞ ﾌｫﾙﾀﾞｰ作成　>>
;@DM10	：ﾌｫﾙﾀﾞｰ名が格納されているｱﾄﾞﾚｽ　(ﾌｫﾙﾀﾞｰ名はEM0〜EM100に格納されている)
;@DM2	：ﾌｫﾙﾀﾞｰ数
;@DM3	：ﾌｫﾙﾀﾞｰ作成数
;
;@MR10	：命令完了 通知ﾋﾞｯﾄ
;@MR11	：ｴﾗｰﾋﾞｯﾄ ON=ｴﾗｰ OFF=ｴﾗｰ無し
;
STG @MR100
ANB CR3214               ; ﾒﾓﾘｶｰﾄﾞ命令実行中
JMP @MR101
STG @MR101
MPS
ANP @MR101
MMKDIR *@DM10 @MR010     ; ﾌｫﾙﾀﾞｰ名格納先ｱﾄﾞﾚｽ  ﾒﾓﾘｰｶｰﾄﾞ命令 通知ﾋﾞｯﾄ
MPP
ANP @MR010               ; ﾒﾓﾘｰｶｰﾄﾞ命令 通知ﾋﾞｯﾄ
MPS
AND @MR011               ; ﾒﾓﾘｰｶｰﾄﾞ命令 ｴﾗｰ
JMP @MR105
MPP
ANB @MR011               ; ﾒﾓﾘｰｶｰﾄﾞ命令 ｴﾗｰ
@INC @DM3                ; ｶｳﾝﾀｰ変数
CON
RES @MR010               ; ﾒﾓﾘｰｶｰﾄﾞ命令 通知ﾋﾞｯﾄ
CON
JMP @MR102
STG @MR102
MPS
AND= @DM2 @DM3           ; ﾌｫﾙﾀﾞｰ数  ｶｳﾝﾀｰ変数
JMP @MR103
MPP
AND<> @DM2 @DM3          ; ﾌｫﾙﾀﾞｰ数  ｶｳﾝﾀｰ変数
TMH @0 #2
CON
AND @T0
ADRADD.S +20 @DM10       ; ﾌｫﾙﾀﾞｰ名格納先ｱﾄﾞﾚｽ
JMP @MR100
;<<　正常終了の場合　>>
STG @MR103
RES @MR010               ; ﾒﾓﾘｰｶｰﾄﾞ命令 通知ﾋﾞｯﾄ
CON
RES @MR011               ; ﾒﾓﾘｰｶｰﾄﾞ命令 ｴﾗｰ
CON
JMP @MR200
;<<　エラー発生の場合　>>
STG @MR105
RES @MR010               ; ﾒﾓﾘｰｶｰﾄﾞ命令 通知ﾋﾞｯﾄ
CON
RES @MR011               ; ﾒﾓﾘｰｶｰﾄﾞ命令 ｴﾗｰ
CON
SET P7                   ; ｴﾗｰﾘﾚｰ
CON
JMP @MR205
;<<　ﾒﾓﾘｶｰﾄﾞ CSVファイル書込み　>>
;@DM100	：ﾌｫﾙﾀﾞｰ名+ﾌｧｲﾙ名
;@DM30	：ﾃﾞｰﾀ格納ｴﾘｱ
;@DM26	：書込みﾃﾞｰﾀ数
;@DM20 	：ﾓｰﾄﾞﾊﾟﾗﾒｰﾀ設定
;
;@MR10	：命令完了 通知ﾋﾞｯﾄ
;@MR11	：ｴﾗｰﾋﾞｯﾄ ON=ｴﾗｰ OFF=ｴﾗｰ無し
;
;<<　ﾊﾟﾗﾒｰﾀﾃﾞｰﾀ1 書込み　>>
STG @MR200
ANB CR3214               ; ﾒﾓﾘｶｰﾄﾞ命令実行中
JMP @MR201
STG @MR201
MPS
ANP @MR201
MWRIT @DM100 *@DM30 @DM26 @DM20 @MR010;ﾌｫﾙﾀﾞｰ+ﾌｧｲﾙ名  書込みﾃﾞｰﾀ格納ｴﾘｱ  書込みﾃﾞｰﾀ数  保存形式の設定  ﾒﾓﾘｰｶｰﾄﾞ命令 通知ﾋﾞｯﾄ
MPP
ANP @MR010               ; ﾒﾓﾘｰｶｰﾄﾞ命令 通知ﾋﾞｯﾄ
MPS
AND @MR011               ; ﾒﾓﾘｰｶｰﾄﾞ命令 ｴﾗｰ
SET P7                   ; ｴﾗｰﾘﾚｰ
CON
JMP @MR205
MPP
ANB @MR011               ; ﾒﾓﾘｰｶｰﾄﾞ命令 ｴﾗｰ
RES P7                   ; ｴﾗｰﾘﾚｰ
CON
JMP @MR205
;<<　終了処理　>>
STG @MR205
RES @MR010               ; ﾒﾓﾘｰｶｰﾄﾞ命令 通知ﾋﾞｯﾄ
CON
RES @MR011               ; ﾒﾓﾘｰｶｰﾄﾞ命令 ｴﾗｰ
CON
MPS
AND P7                   ; ｴﾗｰﾘﾚｰ
MOV CM2390 P8            ; ﾒﾓﾘｶｰﾄﾞ命令用ｴﾗｰｺｰﾄﾞ  ｴﾗｰ情報
MRD
ENDS
MPP
MEND
END
ENDH
