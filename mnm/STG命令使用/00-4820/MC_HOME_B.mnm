DEVICE:53
;MODULE:MC_HOME_B
;MODULE_TYPE:1
;SCRIPT_TYPE:
;OneSystem SupportMacro
;広丘
;-----------------------------------------
;Macro Name 	: 	MC_HOME
;Macro Type	:	Self Holding
;Ver.		:	1.1
;Function	:	MC Unit HOME
;-----------------------------------------
;引数：
;	V0  =  RB_TYPE[2,0~31]                  V3  =  RB_TYPE[2,0~31]
;	P0	=	完了コード					    P0  =  Macro Complete Code
;			#20			=	正常終了				#20 		=	No Error
;			#21			=	RB応答なし				#21 		=	Non Responce
;			#22			=	ｽﾃｰﾀｽ異常		 	    #22 		=	Status Abnormal
;			#23         =   速度設定異常            #23         =   Speed Setting Abnormal
;			#24		    =   Driver ALARM            #24		    =   Driver ALARM
;
;機能：MC UnitによるPULSE列 軸制御  /  Axis PULSE Control From MC Unit
;
LD R59915                ; _運転ﾓｰﾄﾞ指定
ORP R46104               ; _非常停止中　ﾓｰﾄﾞﾌﾗｸﾞ
LD MR20011               ; 加圧冶具側遮光検出
AND R20004               ; 軸3 軸制御中
ORL
ZRES @R000 @R015         ; ﾏｸﾛ実行  ｱﾗｰﾑ発生
CON
MEND
;'MC制御軸の場合のみ実行  UNIT,AXIS No.割出
;
;@DM2.T=STR(RB_TYPE[2,V0]) 'UNIT,AXIS 読出し桁分割
;DISB( @DM2,@EM100,2)
;BSWAP(@EM100,2)
;@DM6= RDASC(@EM100.T)		     'AXIS No.格納
;@DM7= RDASC(@EM101.T)			 'UNIT No.格納
;
;
;@DM22=(W3AE0:(@DM7*4)*16)+((@DM6-1)*8)	'制御ﾃﾞﾊﾞｲｽ修飾
;@DM24=(W3AE0:(@DM7*4)*16)+((@DM6-1)*128)'制御STATUSﾃﾞﾊﾞｲｽ
;@DM26=#452+((@DM6-1)*40) 				'原点復帰完了Code
;ADRSET(R0:@DM24,STATUS)	        	    '制御STATUSﾃﾞﾊﾞｲｽｾｯﾄ
;
;'MC制御軸の場合のみ実行  UNIT,AXIS No.割出
;
;@DM2.T=STR(RB_TYPE[2,V0]) 'UNIT,AXIS 読出し桁分割
;
LD CR2002                ; 常時ON
LDA V0                   ; Arrange_No.
CON
EXT
CON
ADD.L +64
CON
STA.L Z12
LD CR2002                ; 常時ON
ADRSET VM2 VM0
MOV #0 VM2
MOV.D VM0 @VM1
LD CR2002                ; 常時ON
MOV CR2800 @VM0          ; ﾌﾞﾚｰｸ信号送出
SET CR2814               ; ASCII変換ｾﾞﾛｻﾌﾟﾚｽ設定
SET CR2815               ; ASCII変換+符号省略
DASC W3A25:Z12 *@VM1     ; RB1 TYPE
MOV @VM0 CR2800          ; ﾌﾞﾚｰｸ信号送出
LD CR2002                ; 常時ON
SMOV *@VM1 @DM2
;DISB( @DM2,@EM100,2)
;
LD CR2002                ; 常時ON
DISB @DM2 @EM100 #2
;BSWAP(@EM100,2)
;
LD CR2002                ; 常時ON
BSWAP @EM100 #2
;@DM6= RDASC(@EM100.T)		     'AXIS No.格納
;
LD CR2002                ; 常時ON
MOV.L +0 @VM3
RDASC.L @EM100 @VM3
LD CR2002                ; 常時ON
MOV @VM3 @DM6            ; Axis_No
;@DM7= RDASC(@EM101.T)			 'UNIT No.格納
;
LD CR2002                ; 常時ON
MOV.L +0 @VM5
RDASC.L @EM101 @VM5
LD CR2002                ; 常時ON
MOV @VM5 @DM7            ; UNIT_No.
;@DM22=(W3AE0:(@DM7*4)*16)+((@DM6-1)*8)	'制御ﾃﾞﾊﾞｲｽ修飾
;
LD CR2002                ; 常時ON
LDA @DM6                 ; Axis_No
CON
EXT
CON
SUB.L +1
CON
MUL.L +8
CON
STA.L @VM7
CON
LDA @DM7                 ; UNIT_No.
CON
EXT
CON
MUL.L +4
CON
STA.L Z12
CON
LDA W3AE0:Z12            ; UNIT_0 R
CON
EXT
CON
MUL.L +16
CON
ADD.L @VM7
CON
STA @DM22
;@DM24=(W3AE0:(@DM7*4)*16)+((@DM6-1)*128)'制御STATUSﾃﾞﾊﾞｲｽ
;
LD CR2002                ; 常時ON
LDA @DM6                 ; Axis_No
CON
EXT
CON
SUB.L +1
CON
MUL.L +128
CON
STA.L @VM9
CON
LDA @DM7                 ; UNIT_No.
CON
EXT
CON
MUL.L +4
CON
STA.L Z12
CON
LDA W3AE0:Z12            ; UNIT_0 R
CON
EXT
CON
MUL.L +16
CON
ADD.L @VM9
CON
STA @DM24
;@DM26=#452+((@DM6-1)*40) 				'原点復帰完了Code
;
LD CR2002                ; 常時ON
LDA @DM6                 ; Axis_No
CON
EXT
CON
SUB.L +1
CON
MUL.L +40
CON
ADD.L +452
CON
STA @DM26                ; 原点復帰完了Codeﾃﾞﾊﾞｲｽ修飾
;ADRSET(R0:@DM24,STATUS)	        	    '制御STATUSﾃﾞﾊﾞｲｽｾｯﾄ
;
LD CR2002                ; 常時ON
LDA @DM24
CON
EXT
CON
STA.L Z12
ADRSET R000:Z12 STATUS   ; 位置決めSTATUSﾘﾚｰ
;
;入力
LD *STATUS:#704          ; 位置決めSTATUSﾘﾚｰ
OUT AXIS_ERR             ; Axis ERROR
LD *STATUS:#705          ; 位置決めSTATUSﾘﾚｰ
OUT AXIS_WARNING         ; Axis Warnig
LD *STATUS:#708          ; 位置決めSTATUSﾘﾚｰ
OUT BUSY                 ; Busy
LD *STATUS:#716          ; 位置決めSTATUSﾘﾚｰ
OUT HOME_END             ; 原点復帰完了
LD *STATUS:#757          ; 位置決めSTATUSﾘﾚｰ
OUT DRV_ALM              ; Driver ALARM
;--
LD @CR2008
SET @R000                ; ﾏｸﾛ実行
STG @R000                ; ﾏｸﾛ実行
SET @R002                ; ﾏｸﾛ実行中
CON
JMP @R003
STG @R003
JMP @R004
;位置決め開始
STG @R004
SET HOME                 ; 原点復帰開始
CON
MPS
AND HOME_END             ; 原点復帰完了
JMP @R005
MPP
LDB BUSY                 ; Busy
ANB MR20011              ; 加圧冶具側遮光検出
ANB MR20012              ; 接着冶具側遮光検出
ANL
TMR @0 #50
CON
AND @T0
RES HOME                 ; 原点復帰開始
CON
JMP @R006
STG @R005
RES HOME                 ; 原点復帰開始
CON
ANB HOME_END             ; 原点復帰完了
JMP @R006
;完了Code 確認  正常完了は0
STG @R006
UREAD @DM7 @DM26 @DM0 #1 ; UNIT_No.  原点復帰完了Codeﾃﾞﾊﾞｲｽ修飾  位置決め完了Code
MPS
LD= @DM0 #0              ; 位置決め完了Code
ANB DRV_ALM              ; Driver ALARM
ANL
DW #20 P0                ; C_Code
CON
JMP @R008                ; 終了処理
MRD
AND<> @DM0 #0            ; 位置決め完了Code
LDA @DM0                 ; 位置決め完了Code
CON
STA P0                   ; C_Code
CON
JMP @R008                ; 終了処理
MPP
AND DRV_ALM              ; Driver ALARM
DW #24 P0                ; C_Code
CON
JMP @R008                ; 終了処理
;終了処理
STG @R008                ; 終了処理
SET @R001                ; ﾏｸﾛ実行完了
CON
RES @R002                ; ﾏｸﾛ実行中
CON
ENDS
LD @R001                 ; ﾏｸﾛ実行完了
RES @R001                ; ﾏｸﾛ実行完了
CON
MEND
;出力
LD HOME                  ; 原点復帰開始
OUT *STATUS:#652         ; 位置決めSTATUSﾘﾚｰ
LD DRV_ALM_RES           ; Driver ALARM Reset
OUT *STATUS:#693         ; 位置決めSTATUSﾘﾚｰ
LD AXIS_ERR_CL           ; Axis ERROR CLEAR
OUT *STATUS:#640         ; 位置決めSTATUSﾘﾚｰ
END
ENDH
