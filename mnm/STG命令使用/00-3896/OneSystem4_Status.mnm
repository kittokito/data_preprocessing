DEVICE:53
;MODULE:OneSystem4_Status
;MODULE_TYPE:0
;OneSystem Master-Module
;
;-----------------------------------------
;ModuleName	:	OneSystem4_Status
;ModuleType	:	Master Module
;Function	:	Status Control
;-----------------------------------------
;
;Copylight(C) 2011 SEIKO EPSON Corp. All rights reserved.
;<h1/>Emergency Stop/非常停止処理
;非常停止要求発生待ち
;・非常停止SW押下
;・優先ｴﾗｰ(F_ERROR_DISP)
;・ｼｽﾃﾑｴﾗｰ
LDB R46104
MPS
ANB R44300
BSET DM2008 #0
MRD
AND R47400
BSET DM2008 #1
MRD
AND R40009
BSET DM2008 #2
MPP
AND CR2003
BSET DM2008 #3
BSET DM2008 #4
;非常停止処理
;優先ｴﾗｰｺｰﾄﾞ転送
;・非常停止SW押下時優先ｴﾗｰ画面出力(ｴﾗｰ番号は#64固定)
;・ｼｽﾃﾑｴﾗｰはｴﾗｰｺｰﾄﾞ確認
LD<> DM2008 #0
MPS
BAND DM2008 #0
MOV #64 DM8100
MOV #64 DM8101
SET R53008
MRD
BAND DM2008 #2
MOV DM2003 DM8100
MOV DM2003 DM8101
SET R53008
MPP
SET R46104
;非常停止時初期化処理
;・ﾒｲﾝﾓｼﾞｭｰﾙ停止
;・非常停止要因によるﾃﾞﾊﾞｲｽ初期化
;・Estop_Handle
LDP R46104
MPS
AND _BringDown_Standby
MDSTOP BringDown_Standby
MRD
AND R40100
SET R47308
MRD
RES R46100
CON
RES R46101
CON
RES R46102
CON
RES R46105
CON
RES R46115
CON
RES R46106
CON
RES R46107
MRD
ZRES R47800 R47807
CON
ZRES R47900 R47907
CON
ZRES R40100 R40107
CON
ZRES R41000 R42515
CON
ZRES R47500 R47507
CON
ZRES LR400 LR9915
CON
ZRES R47708 R47715
MRD
ZRES R46208 R46215
CON
ZRES R42600 R44015
CON
ZRES R44200 R44207
CON
ZRES R46300 R46307
CON
ZRES R48000 R48107
CON
ZRES R48208 R48407
CON
ZRES R48408 R48607
MRD
ZRES R53000 R53002
CON
ZRES R53100 R53412
CON
ZRES R53500 R53615
CON
ZRES R53700 R54108
CON
ZRES R54714 R54814
CON
ZRES R55000 R55207
CON
ZRES R55300 R55309
MRD
ZRES R40400 R40404
CON
ZRES R40407 R40915
MRD
MOV #0 DM2009
MRD
FMOV #0 DM5500 #256
MRD
FMOV #0 DM5800 #256
MRD
FMOV #0 DM8000 #100
MPP
FMOV #0 DM8156 #222
;Task全終了後、Estop_Handle実行
LD R46104
ANB _BringDown_Standby
@SET R40405
;非常停止復帰待ち
;・非常停止SW解除
;・優先ｴﾗｰ画面消去
LD R46104
ANB R40405
MPS
BLD DM2008 #0
AND R44300
ANP R53009
ANL
RES R53008
CON
BRES DM2008 #0
MRD
BLD DM2008 #1
ANP R53009
ANL
RES R47400
CON
RES R53008
CON
BRES DM2008 #1
MRD
BLD DM2008 #2
ANP R53009
ANL
RES R40009
CON
RES R53008
CON
BRES DM2008 #2
MRD
BAND DM2008 #3
BRES DM2008 #3
MPP
BAND DM2008 #4
BRES DM2008 #4
;非常停止要因解除処理
;・安全回路非常停止出力解除
;・TRAPDO解除
;・Estop_Revival
LD R46104
AND= DM2008 #0
RES R44308
CON
TMR @0 DM9350
CON
AND @T0
RES R46104
LDF R46104
MPS
SET R46103
MPP
LDB R46104
AND R46103
ANL
SET R40406
CON
SET @R001
STG @R001
ANB R40406
ENDS
;<h1/>Air Pressure/ｴｱｰ元圧処理
;<h1/>common/共通処理
;ｴｱｰ元圧低下中非常停止復帰時ﾓｼﾞｭｰﾙ未起動処理
;・ｴｱｰ圧低下中の非常停止発生にてAir_Factorをｸﾘｱして復帰時にﾓｼﾞｭｰﾙ起動させない
LDP R46104
MOV #0 DM2009
;<ｴｱｰ元圧低下状態まとめ>
;1CPU/ｸﾞﾙｰﾌﾟ毎に係わらず各ｸﾞﾙｰﾌﾟのｴｱｰ元圧状態をAirState*に格納
;→OneSystemが使用する(AIR_LOW*だと他の箇所での確認が複雑になるので)
;・1CPU1系統の場合→AIR_LOW状態をAirStateに出力
;・ｸﾞﾙｰﾌﾟ毎の場合→各ｸﾞﾙｰﾌﾟのAIR_LOW状態をAirStateに出力
LD= DM9320 #0
OR= DM9320 #1
AND R46008
OUT R50700
LD= DM9320 #0
AND R46008
LD= DM9320 #1
AND R46009
ORL
OUT R50701
LD= DM9320 #0
AND R46008
LD= DM9320 #1
AND R46010
ORL
OUT R50702
;<ｴｱｰ元圧検出監視設定機能>
;	・常時監視(AirPress_Moni=0)
;	・安全ｶﾊﾞｰ開中のみ監視無効(AirPress_Moni=1)←本選択されている場合の処理
;監視無効条件まとめ
;・AirPress_Moni=1(安全ｶﾊﾞｰ開処理中監視無効)に設定されている
;・元圧検出が1CPU1系統の場合はいずれかの安全ｶﾊﾞｰ開処理中が成立したらｷｬﾝｾﾙ可能
;・元圧検出が1ｸﾞﾙｰﾌﾟ1系統の場合は自系統安全ｶﾊﾞｰ開処理中が成立したらｷｬﾝｾﾙ可能
;安全ｶﾊﾞｰ開処理開始にて監視無効処理開始
LD= DM9321 #1
MPS
AND= DM9320 #0
LDA R46700
CON
ANDA $00FF
CON
CMP #0
CON
AND CR2011
MEP
SET R50600
CON
SET @R1900
MPP
AND= DM9320 #1
MPS
ANP R46700
SET R50600
CON
SET @R1900
MRD
ANP R46701
SET R50601
CON
SET @R1908
MPP
ANP R46702
SET R50602
CON
SET @R2000
;<Group1> or <全系統>
;安全ｶﾊﾞｰ開待ち
STG @R1900
MPS
AND= DM9320 #0
LDA R46200
CON
ANDA $00FF
CON
CMP #0
CON
AND CR2011
JMP @R1901
MPP
LD= DM9320 #1
AND R46200
ANL
JMP @R1901
;安全ｶﾊﾞｰ閉待ち
STG @R1901
MPS
AND= DM9320 #0
LDA R46200
CON
ANDA $00FF
CON
CMP #0
CON
AND CR2010
JMP @R1902
MPP
LD= DM9320 #1
ANB R46200
ANL
JMP @R1902
;元圧低下していたらﾗｯﾁ解除、それでも復帰しなければ元圧低下処理へ
STG @R1902
MPS
ANB R44302
JMP @R1903
MPP
AND R44302
RES R50600
CON
ENDS
STG @R1903
SET R44309
CON
TMR @40 DM9354
CON
AND @T40
JMP @R1904
STG @R1904
RES R44309
CON
MPS
AND R44302
RES R50600
CON
ENDS
MPP
ANB R44302
RES R50600
CON
MPS
AND= DM9320 #0
SET @R110
CON
ENDS
MPP
AND= DM9320 #1
SET @R1800
CON
ENDS
;●Ver0.10〜
;ｴｱｰ元圧系統を1CPU/ｸﾞﾙｰﾌﾟ毎管理選択可能とする(AirPress_Sys =0:1CPU1系統、=1:ｸﾞﾙｰﾌﾟ毎系統)
;<h1/>case 1CPU-1System Proc/1CPU1系統処理
;【1CPU1系統の場合】AirPress_Sys = #0
LD= DM9320 #0
MC
;運転開始時ﾗｯﾁ解除処理
;・元圧低下していたら低下状態へ移行
LD CR2008
MPS
ANB R44302
SET R46008
MPP
SET @R104
;ｴｱｰ元圧低下監視
;・(通常)監視有効状態でｴｱｰ元圧検出(AIR_PRES)がOFFした場合
;・監視無効状態が終了した時ｴｱｰ元圧検出がOFFしていた場合
LDB R46008
LDB R50600
ANF R44302
ORP @R110
ANL
MPS
RES @R110
CON
SET @R100
MRD
AND<>.D R41000 #0
BSET DM2009 #0
CON
SET R47308:#0
MRD
AND<>.D R41200 #0
BSET DM2009 #1
CON
SET R47308:#1
MRD
AND<>.D R41400 #0
BSET DM2009 #2
CON
SET R47308:#2
MPP
AND _BringDown_Standby
BSET DM2009 #8
CON
MDSTOP BringDown_Standby
;Task停止待ち
;・起動Taskの全停止待ち
STG @R100
ANB _BringDown_Standby
LDA R47308
CON
ANDA $00FF
CON
CMP #0
CON
AND CR2010
SET R46008
CON
SET R40800
CON
JMP @R101
STG @R101
ANB R40800
JMP @R102
;ｴｱｰ元圧解除処理
;・安全ｶﾊﾞｰ未処理+STARTｽｲｯﾁでｴｱｰﾗｯﾁ解除処理へ
;(安全ｶﾊﾞｰが開いていたら最初のSTARTｽｲｯﾁは安全ｶﾊﾞｰを閉める)
LDB R44400
ANB R44600
ANB R44800
ANB R45000
ANB R45200
ANB R45400
ANB R45600
ANB R45800
OUT StartSwOFF           ; 全ｽﾀｰﾄSWｵﾌ状態
STG @R102
LDA R46700
CON
ANDA $00FF
CON
CMP #0
CON
AND CR2010
AND StartSwOFF           ; 全ｽﾀｰﾄSWｵﾌ状態
JMP @R103
STG @R103
ANP R44400
JMP @R104
;・AIRﾗｯﾁ解除〜元圧ｾﾝｻ復帰待ち
STG @R104
SET R44309
CON
TMR @1 DM9354
CON
AND @T1
JMP @R105
STG @R105
RES R44309
CON
MPS
AND R44302
JMP @R106
MPP
ANB R44302
JMP @R102
;・ﾒｲﾝﾓｼﾞｭｰﾙ再開処理
STG @R106
SET R40801
CON
JMP @R107
STG @R107
ANB R40801
RES R46008
CON
JMP @R108
STG @R108
ANB R46104
MPS
JMP @R109
MPP
BAND DM2009 #0
SET R47300
STG @R109
BLDB DM2009 #0
OR R40100
ANL
BLDB DM2009 #8
OR _BringDown_Standby
ANL
MOV #0 DM2009
ENDS
MCR
;<h1/>case 1Group-1System Proc/1Group1系統処理
;【各ｸﾞﾙｰﾌﾟ1系統】AirPress_Sys = #1
LD= DM9320 #1
MC
;Group1
LD CR2008
MPS
ANB R44302
SET R46008
MPP
SET @R1004
LDB R50600
ANB R46008
LDB R50600
ANF R44302
ORP @R1800
ANL
MPS
RES @R1800
CON
SET @R1000
MPP
AND<>.D R41000 #0
BSET DM2009 #0
CON
SET R47308
STG @R1000
ANB R47308
SET R46008
CON
SET R40800
CON
JMP @R1001
STG @R1001
ANB R40800
JMP @R1002
STG @R1002
ANB R46700
ANB R44400
JMP @R1003
STG @R1003
ANP R44400
JMP @R1004
STG @R1004
SET R44309
CON
TMR @30 DM9354
CON
AND @T30
JMP @R1005
STG @R1005
RES R44309
CON
MPS
AND R44302
JMP @R1006
MPP
ANB R44302
JMP @R1002
STG @R1006
SET R40801
CON
JMP @R1007
STG @R1007
ANB R40801
RES R46008
CON
JMP @R1008
STG @R1008
ANB R46104
MPS
JMP @R1009
MPP
BAND DM2009 #0
SET R47300
STG @R1009
BLDB DM2009 #0
OR R40100
ANL
BRES DM2009 #0
CON
ENDS
MCR
;<h1/>Area Sensor/ｴﾘｱｾﾝｻ処理
;Group1
;ｴﾘｱｾﾝｻ有効出力
;・ｸﾞﾙｰﾌﾟ有効ﾀｽｸ有り AND ｴﾘｱｾﾝｻ有効でｴﾘｱｾﾝｻ使用出力
;運転開始時ﾗｯﾁ解除
LD>= DM9200 #1
AND R59600
MPS
OUT R40300
MPP
AND CR2008
SET @R202
;ｴﾘｱｾﾝｻ遮断監視
;・非常停止、定停止中は検出しない
;・遮断検知したら遮断中ﾌﾗｸﾞSET
;・ﾕｰｻﾞｰ解放ﾌｧﾝｸｼｮﾝSET
LD R40300
ANB R46104
ANB R46103
ANB R46300
AND R50900
ANB R44304
SET R46300
CON
SET R40900
CON
SET @R200
STG @R200
ANB R40900
JMP @R201
;ｴﾘｱｾﾝｻ復帰SW待ち
;・使用SWが1個の場合、復帰SW1が押されたらﾗｯﾁ解除へ
;・使用SWが2個の場合、0.5秒以内に両方のSWが押されたらﾗｯﾁ解除へ
STG @R201
MPS
LD= DM9211 #1
AND R44404
ANL
JMP @R202
MPP
LD= DM9211 #2
AND @R208
AND @R209
ANL
JMP @R202
;ｴﾘｱｾﾝｻ復帰SW2個押し処理
;・SWが押されて0.5秒経過したら押下記憶RES
LD @R201
MPS
LDP R44404
ANB @T10
ANL
SET @R208
MRD
LDP R44405
ANB @T11
ANL
SET @R209
MRD
AND @R208
TMR @10 #5
CON
AND @T10
RES @R208
MPP
AND @R209
TMR @11 #5
CON
AND @T11
RES @R209
;ｴﾘｱｾﾝｻﾗｯﾁ解除
STG @R202
SET R44311
CON
TMR @2 DM9356
CON
AND @T2
JMP @R203
;ｴﾘｱｾﾝｻ入力復帰待ち
STG @R203
RES @R208
CON
RES @R209
CON
RES R44311
CON
MPS
AND R44304
SET R40901
CON
JMP @R204
MPP
ANB R44304
JMP @R201
STG @R204
ANB R40901
RES R46300
CON
ENDS
;定停止中ONで解除
LDP R46103
ZRES R50900 R50907
END
ENDH
