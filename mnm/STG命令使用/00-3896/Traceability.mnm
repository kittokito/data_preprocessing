DEVICE:53
;MODULE:Traceability
;MODULE_TYPE:0
;SCRIPT_TYPE:
;トレーサビリティデータ作成
LD CR2008
DW #0 @DM50
CON
ZRES @R000 @R1915
LD CR2003
ZRES @DM800 @DM899
;<h1/>処理開始
STG R42000
ANB R42002
ANB R42010
ANB R42102
SET R42002
CON
JMP @R103
STG R42008
ANB R42002
ANB R42010
ANB R42102
SET R42010
CON
JMP @R103
STG R42100
ANB R42002
ANB R42010
ANB R42102
SET R42102
CON
JMP @R103
;空き容量チェック
STG @R103
SET @R102
CON
MPS
MFREEK @DM112 @R104
MPP
AND @R104
MPS
ANB @R105
JMP @R108
MPP
AND @R105
SET @R700
CON
JMP @R106
STG @R106
AND @R701
RES @R701
CON
ZRES @R104 @R105
CON
JMP @R103
;1MB以下はﾌｫﾙﾀﾞ削除
STG @R108
ZRES @R104 @R105
CON
MPS
AND>=.D #1000 @DM112
JMP @R109
MPP
AND<.D #1000 @DM112
JMP @R200
;FTP送信
STG @R109
MPS
AND= @DM110 #0
JMP @R200
MPP
AND<> @DM110 #0
SET @R1000
CON
JMP @R110
STG @R110
AND @R1001
RES @R1001
CON
JMP @R111
;FOLDER 削除
STG @R111
MPS
MRMDIR "Traceability" @R112
MPP
AND @R112
MPS
ANB @R113
JMP @R200
MPP
AND @R113
SET @R700
CON
JMP @R114
STG @R114
AND @R701
RES @R701
CON
ZRES @R112 @R113
CON
JMP @R111
;ﾌｫﾙﾀﾞ作成
STG @R200
ZRES @R112 @R113
CON
MPS
MMKDIR "Traceability" @R201
MPP
AND @R201
MPS
ANB @R202
JMP @R204
MPP
AND @R202
SET @R700
CON
JMP @R203
STG @R203
AND @R701
RES @R701
CON
ZRES @R201 @R202
CON
JMP @R200
;書込み回数確認
STG @R204
ZRES @R201 @R202
CON
MPS
AND= @DM110 #0
ZRES @DM120 @DM149
CON
JMP @R205
MPP
AND<> @DM110 #0
JMP @R207
;FILE作成
STG @R205
AND @R206
RES @R206
CON
JMP @R207
;   TYPE @DM100-@DM108.U
;BMOV(CM700,@DM100,6)		'日時読み込み
;FOR @DM108 = 0 TO 5
;	@DM800.U:@DM108 = ASC(TBCD(@DM100:@DM108))'File名ﾀｲﾑｽﾀﾝﾌﾟ部分
;NEXT
;
;@DM120.T = "Traceability\C01_01_" + @DM800.T+CHR($00)'FILE名
;
;SET(@R206)
LD @R205
ANB @R206
NCJ #1002
;   TYPE @DM100-@DM108.U
;
;BMOV(CM700,@DM100,6)		'日時読み込み
;
LD CR2002
BMOV CM700 @DM100 #6
;FOR @DM108 = 0 TO 5
;
LD CR2002
MOV #0 @DM108
LABEL #2000
LD> @DM108 #5
CJ #2001
;	@DM800.U:@DM108 = ASC(TBCD(@DM100:@DM108))'File名ﾀｲﾑｽﾀﾝﾌﾟ部分
;
LD CR2002
LDA @DM108
CON
EXT
CON
STA.L Z11
CON
LDA @DM108
CON
EXT
CON
STA.L Z12
CON
LDA @DM100:Z12
CON
TBCD
CON
ASC
CON
STA @DM800:Z11
;NEXT
;
LD CR2002
INC @DM108
LDB CR2009
CJ #2000
LABEL #2001
;@DM120.T = "Traceability\C01_01_" + @DM800.T+CHR($00)'FILE名
;
LD CR2002
ADRSET VM2 VM0
MOV #0 VM2
MOV.D VM0 @VM1
LD CR2002
LDA $0000
CON
SLA #8
CON
STA @VM0
CON
SMOV @VM0 *@VM1
LD CR2002
ADRADD.S +1 VM0
LD CR2002
MOV.D VM0 @VM3
SMOV "Traceability\C01_01_" *@VM3
LD CR2002
SADD *@VM3 @DM800 *@VM3
SADD *@VM3 *@VM1 *@VM3
SMOV *@VM3 @DM120
;SET(@R206)
LD CR2002
SET @R206
LABEL #1002
;
;<h1/>DATA書込み開始
STG @R207
@INC @DM110
CON
ANB @R302
ANB CR3214
MPS
AND R42002
SET @R300
CON
JMP @R208
MRD
AND R42010
SET @R400
CON
JMP @R208
MPP
AND R42102
SET @R500
CON
JMP @R208
STG @R208
LD @R301
OR @R401
OR @R501
ANL
RES @R301
CON
RES @R401
CON
RES @R501
CON
JMP @R209
STG @R209
MPS
LDB @R303
ANB @R403
ANB @R503
ANL
JMP @R211
MPP
LD @R303
OR @R403
OR @R503
ANL
SET @R800
CON
JMP @R210
STG @R210
RES @R303
CON
RES @R403
CON
RES @R503
CON
AND @R801
RES @R801
CON
@DEC @DM110
CON
JMP @R207
STG @R211
MPS
LDB @T0
AND< @DM110 #120
ANL
JMP @R214
MPP
LD @T0
OR>= @DM110 #120
ANL
JMP @R212
;10分経過 or 40回書込み FTPアップロード
STG @R212
SET @R1000
CON
JMP @R213
STG @R213
AND @R1001
RES @R1001
CON
JMP @R214
STG @R214
MPS
AND R42002
RES R42002
CON
SET R42001
CON
ENDS
MRD
AND R42010
RES R42010
CON
RES R42009
CON
ENDS
MPP
AND R42102
RES R42102
CON
RES R42101
CON
ENDS
;<h1/>-----ﾄﾚｻﾋﾞﾃﾞｰﾀ書込み見本
;工程1
STG @R300
DW #0 @DM50
CON
SET @R302
CON
AND @R311
RES @R311
CON
JMP @R304
;   	W2000 = 1
;	W2001.T = "CAVID1234567891"
;	W2009 =  W2009+1'ﾜｰｸ番地
;	W200A = #100 '100=良品
;	 BMOV(CM700,W200B,6)'ﾀｲﾑｽﾀﾝﾌﾟ
;	'W2011= 1'INDEX Pos
;	
;SET(@R311)
;
LD @R302
ANB @R311
NCJ #1000
;   	W2000 = 1
;
LD CR2002
MOV #1 W2000
;	W2001.T = "CAVID1234567891"
;
LD CR2002
SMOV "CAVID1234567891" W2001
;	W2009 =  W2009+1'ﾜｰｸ番地
;
LD CR2002
LDA W2009
CON
EXT
CON
ADD.L +1
CON
STA W2009
;	W200A = #100 '100=良品
;
LD CR2002
MOV #100 W200A
;	 BMOV(CM700,W200B,6)'ﾀｲﾑｽﾀﾝﾌﾟ
;
LD CR2002
BMOV CM700 W200B #6
;	'W2011= 1'INDEX Pos
;
;SET(@R311)
;
LD CR2002
SET @R311
LABEL #1000
;
STG @R304
MPS
LDB R41900
ANB CR3214
ANL
MPS
AND= @DM50 #0
DW #4 DM9400
CON
DW #0 DM9401
CON
DW $0000 DM9402
CON
MWRIT @DM120 W2000 #1 DM9400 R41900
MRD
AND= @DM50 #1
DW #8 DM9400
CON
DW #0 DM9401
CON
DW.D #0 DM9402
CON
MWRIT @DM120 W2001 #16 DM9400 R41900
MPP
AND= @DM50 #2
DW #4 DM9400
CON
DW #0 DM9401
CON
DW #1 DM9402
CON
MWRIT @DM120 W2009 #8 DM9400 R41900
MPP
ANP R41900
@INC @DM50
CON
MPS
ANB R41901
JMP @R305
MPP
AND R41901
SET @R303
CON
JMP @R306
STG @R305
ZRES R41900 R41901
CON
MPS
AND< @DM50 #3
JMP @R304
MPP
AND= @DM50 #3
JMP @R306
STG @R306
RES @R302
CON
SET @R301
CON
ENDS
;工程2
STG @R400
DW #0 @DM50
CON
SET @R402
CON
AND @R411
RES @R411
CON
JMP @R404
;   	W2020 = 2
;	W2021.T = "CAVID1234567891"
;	W2029 =  W2009+1'ﾜｰｸ番地
;	W202A = #100 '100=良品
;	 BMOV(CM700,W202B,6)'ﾀｲﾑｽﾀﾝﾌﾟ
;	W2031.T= "CR WF ID"
;	W2039 = W2039+1'ﾜｰｸ番地
;	
;SET(@R411)
;
LD @R402
ANB @R411
NCJ #1005
;   	W2020 = 2
;
LD CR2002
MOV #2 W2020
;	W2021.T = "CAVID1234567891"
;
LD CR2002
SMOV "CAVID1234567891" W2021
;	W2029 =  W2009+1'ﾜｰｸ番地
;
LD CR2002
LDA W2009
CON
EXT
CON
ADD.L +1
CON
STA W2029
;	W202A = #100 '100=良品
;
LD CR2002
MOV #100 W202A
;	 BMOV(CM700,W202B,6)'ﾀｲﾑｽﾀﾝﾌﾟ
;
LD CR2002
BMOV CM700 W202B #6
;	W2031.T= "CR WF ID"
;
LD CR2002
SMOV "CR WF ID" W2031
;	W2039 = W2039+1'ﾜｰｸ番地
;
LD CR2002
LDA W2039
CON
EXT
CON
ADD.L +1
CON
STA W2039
;SET(@R411)
;
LD CR2002
SET @R411
LABEL #1005
;
STG @R404
MPS
LDB R41900
ANB CR3214
ANL
MPS
AND= @DM50 #0
DW #4 DM9400
CON
DW #0 DM9401
CON
DW $0000 DM9402
CON
MWRIT @DM120 W2020 #1 DM9400 R41900
MRD
AND= @DM50 #1
DW #8 DM9400
CON
DW #0 DM9401
CON
DW.D #0 DM9402
CON
MWRIT @DM120 W2021 #16 DM9400 R41900
MRD
AND= @DM50 #2
DW #4 DM9400
CON
DW #0 DM9401
CON
DW #0 DM9402
CON
MWRIT @DM120 W2029 #8 DM9400 R41900
MRD
AND= @DM50 #3
DW #8 DM9400
CON
DW #0 DM9401
CON
DW #0 DM9402
CON
MWRIT @DM120 W2031 #16 DM9400 R41900
MPP
AND= @DM50 #4
DW #4 DM9400
CON
DW #0 DM9401
CON
DW #1 DM9402
CON
MWRIT @DM120 W2039 #1 DM9400 R41900
MPP
ANP R41900
@INC @DM50
CON
MPS
ANB R41901
JMP @R405
MPP
AND R41901
SET @R403
CON
JMP @R406
STG @R405
ZRES R41900 R41901
CON
MPS
AND< @DM50 #5
JMP @R404
MPP
AND= @DM50 #5
JMP @R406
STG @R406
RES @R402
CON
SET @R401
CON
ENDS
;工程3
STG @R500
DW #0 @DM50
CON
SET @R502
CON
AND @R511
RES @R511
CON
JMP @R504
;   	W2040 = 3
;	W2041.T = "ID1234567891112"
;	W2049.T = "C+R WF ID"
;	W2051 = W2051+1'格納位置
;	 BMOV(CM700,W2052,6)'ﾀｲﾑｽﾀﾝﾌﾟ
;	
;SET(@R511)
;
LD @R502
ANB @R511
NCJ #1006
;   	W2040 = 3
;
LD CR2002
MOV #3 W2040
;	W2041.T = "ID1234567891112"
;
LD CR2002
SMOV "ID1234567891112" W2041
;	W2049.T = "C+R WF ID"
;
LD CR2002
SMOV "C+R WF ID" W2049
;	W2051 = W2051+1'格納位置
;
LD CR2002
LDA W2051
CON
EXT
CON
ADD.L +1
CON
STA W2051
;	 BMOV(CM700,W2052,6)'ﾀｲﾑｽﾀﾝﾌﾟ
;
LD CR2002
BMOV CM700 W2052 #6
;SET(@R511)
;
LD CR2002
SET @R511
LABEL #1006
;
STG @R504
MPS
LDB R41900
ANB CR3214
ANL
MPS
AND= @DM50 #0
DW #4 DM9400
CON
DW #0 DM9401
CON
DW $0000 DM9402
CON
MWRIT @DM120 W2040 #1 DM9400 R41900
MRD
AND= @DM50 #1
DW #8 DM9400
CON
DW #0 DM9401
CON
DW.D #0 DM9402
CON
MWRIT @DM120 W2041 #16 DM9400 R41900
MRD
AND= @DM50 #2
DW #8 DM9400
CON
DW #0 DM9401
CON
DW #0 DM9402
CON
MWRIT @DM120 W2049 #16 DM9400 R41900
MPP
AND= @DM50 #3
DW #4 DM9400
CON
DW #0 DM9401
CON
DW #1 DM9402
CON
MWRIT @DM120 W2051 #7 DM9400 R41900
MPP
ANP R41900
@INC @DM50
CON
MPS
ANB R41901
JMP @R505
MPP
AND R41901
SET @R503
CON
JMP @R506
STG @R505
ZRES R41900 R41901
CON
MPS
AND< @DM50 #4
JMP @R504
MPP
AND= @DM50 #4
JMP @R506
STG @R506
RES @R502
CON
SET @R501
CON
ENDS
;<h1/>FTP送信:ReName
STG @R1000
SET @R1002
CON
JMP @R1003
STG @R1003
AND @R1004
JMP @R1005
;@DM700.T = @DM120.T+".CSV"+ CHR($00)
;SET(@R1004)
LD @R1003
ANB @R1004
NCJ #1003
;@DM700.T = @DM120.T+".CSV"+ CHR($00)
;
LD CR2002
ADRSET VM2 VM0
MOV #0 VM2
MOV.D VM0 @VM6
LD CR2002
LDA $0000
CON
SLA #8
CON
STA @VM5
CON
SMOV @VM5 *@VM6
LD CR2002
ADRADD.S +1 VM0
LD CR2002
MOV.D VM0 @VM8
SMOV @DM120 *@VM8
LD CR2002
SADD *@VM8 ".CSV" *@VM8
SADD *@VM8 *@VM6 *@VM8
SMOV *@VM8 @DM700
;SET(@R1004)
LD CR2002
SET @R1004
LABEL #1003
;
STG @R1005
RES @R1004
CON
JMP @R1006
STG @R1006
MPS
MREN @DM700 "C01_01.csv" @R1007
MPP
AND @R1007
MPS
ANB @R1008
JMP @R1200
MPP
AND @R1008
SET @R700
CON
JMP @R1009
STG @R1009
AND @R701
RES @R701
CON
ZRES @R1007 @R1008
CON
JMP @R1010
STG @R1010
MPS
AND= CM2390 #4
JMP @R1100
MPP
AND<> CM2390 #4
JMP @R1003
;既にフォルダー内に同じ送信FILE名称がある場合：送信→名称変更
STG @R1100
SET @R1300
CON
JMP @R1101
STG @R1101
AND @R1301
RES @R1301
CON
JMP @R1102
STG @R1102
AND @R1103
JMP @R1104
;BMOV(CM700,@DM100,6)		'日時読み込み
;FOR @DM108 = 0 TO 5
;	@DM850.U:@DM108 = ASC(TBCD(@DM100:@DM108))
;NEXT
;
;@DM700.T="C01_01_"+@D850.T+CHR($00)
;
;SET(@R1103)
;
LD @R1102
ANB @R1103
NCJ #1004
;BMOV(CM700,@DM100,6)		'日時読み込み
;
LD CR2002
BMOV CM700 @DM100 #6
;FOR @DM108 = 0 TO 5
;
LD CR2002
MOV #0 @DM108
LABEL #2002
LD> @DM108 #5
CJ #2003
;	@DM850.U:@DM108 = ASC(TBCD(@DM100:@DM108))
;
LD CR2002
LDA @DM108
CON
EXT
CON
STA.L Z11
CON
LDA @DM108
CON
EXT
CON
STA.L Z12
CON
LDA @DM100:Z12
CON
TBCD
CON
ASC
CON
STA @DM850:Z11
;NEXT
;
LD CR2002
INC @DM108
LDB CR2009
CJ #2002
LABEL #2003
;@DM700.T="C01_01_"+@D850.T+CHR($00)
;
LD CR2002
ADRSET VM2 VM0
MOV #0 VM2
MOV.D VM0 @VM11
LD CR2002
LDA $0000
CON
SLA #8
CON
STA @VM10
CON
SMOV @VM10 *@VM11
LD CR2002
ADRADD.S +1 VM0
LD CR2002
MOV.D VM0 @VM13
SMOV "C01_01_" *@VM13
LD CR2002
SADD *@VM13 @DM850 *@VM13
SADD *@VM13 *@VM11 *@VM13
SMOV *@VM13 @DM700
;SET(@R1103)
;
LD CR2002
SET @R1103
LABEL #1004
;
STG @R1104
RES @R1103
CON
JMP @R1105
STG @R1105
MPS
MREN @DM700 "C01_01.csv" @R1106
MPP
AND @R1106
MPS
ANB @R1107
JMP @R1003
MPP
AND @R1107
SET @R700
CON
JMP @R1108
STG @R1108
AND @R701
RES @R701
CON
JMP @R1102
;送信
STG @R1200
ZRES @R1007 @R1008
CON
SET @R1300
CON
JMP @R1201
STG @R1201
AND @R1301
RES @R1301
CON
JMP @R1205
;送信後元のFile名に戻す
STG @R1205
AND @R1004
JMP @R1207
;@DM700.T="C01_01_" + @D800.T +".CSV"+CHR($00)
;SET(@R1004)
LD @R1205
ANB @R1004
NCJ #1001
;@DM700.T="C01_01_" + @D800.T +".CSV"+CHR($00)
;
LD CR2002
ADRSET VM2 VM0
MOV #0 VM2
MOV.D VM0 @VM16
LD CR2002
LDA $0000
CON
SLA #8
CON
STA @VM15
CON
SMOV @VM15 *@VM16
LD CR2002
ADRADD.S +1 VM0
LD CR2002
MOV.D VM0 @VM18
SMOV "C01_01_" *@VM18
LD CR2002
SADD *@VM18 @DM800 *@VM18
SADD *@VM18 ".CSV" *@VM18
SADD *@VM18 *@VM16 *@VM18
SMOV *@VM18 @DM700
;SET(@R1004)
LD CR2002
SET @R1004
LABEL #1001
;
STG @R1207
MPS
RES @R1004
CON
MREN "Traceability\Cnn_0n.csv" @DM700 @R1208
MPP
AND @R1208
MPS
ANB @R1209
JMP @R1211
MPP
AND @R1209
SET @R700
CON
JMP @R1210
STG @R1210
AND @R701
RES @R701
CON
ZRES @R1208 @R1209
CON
JMP @R1207
STG @R1211
ZRES @R1208 @R1209
CON
RES @R102
CON
RES @R1002
CON
SET @R1001
CON
ENDS
;<h1/>FTP送信
STG @R1300
SET @R1302
CON
JMP @R1303
STG @R1303
AND R33215
ANB R33100
ANB R32100
@SET R32000
CON
AND R33000
JMP @R1304
STG @R1304
RES R32000
CON
MPS
LDB R33100
ANB R33000
ANL
DW #0 @DM110
CON
JMP @R1308
MPP
AND R33100
SET R32100
CON
JMP @R1305
STG @R1305
ANB R33000
RES R32100
CON
JMP @R1306
STG @R1306
SET @R708
CON
JMP @R1307
STG @R1307
AND @R709
RES @R709
CON
JMP @R1300
STG @R1308
SET @R1301
CON
RES @R1302
CON
ENDS
;<h1/>MyTask Error Process Substance/エラー処理実体
STG @R600
ANB R39002
MPS
ZRES @R605 @R608
CON
LDA @DM9
CON
TBCD
CON
STA @DM10
CON
DISN @DM10 @DM3 #4
MRD
DW #0 @DM0
CON
BMOV @DM0 DM60000 #7
MPP
SET R39000
CON
SET @R602
CON
JMP @R603
STG @R603
AND R39002
AND= DM60008 @DM1
MPS
AND= DM60007 @DM6
SET @R605
CON
JMP @R604
MRD
AND= DM60007 @DM5
SET @R606
CON
JMP @R604
MRD
AND= DM60007 @DM4
SET @R607
CON
JMP @R604
MPP
AND= DM60007 @DM3
SET @R608
CON
JMP @R604
STG @R604
ANB R39002
RES @R602
CON
SET @R601
CON
ENDS
;<h1/>ERROR
;ERROR200:MemoryAccess
STG @R700
ZRES @R104 @R105
CON
ANB R39004
SET R39004
CON
DW #1000 @DM9
CON
DW #200 @DM1
CON
DW #0 @DM2
CON
SET @R600
CON
JMP @R702
STG @R702
AND @R601
RES @R601
CON
RES R39004
CON
AND @R605
SET @R701
CON
ENDS
;ERROR201:FTP送信ERROR
STG @R708
ZRES @R104 @R105
CON
ANB R39004
SET R39004
CON
DW #1000 @DM9
CON
DW #201 @DM1
CON
DW #0 @DM2
CON
SET @R600
CON
JMP @R711
STG @R711
AND @R601
RES @R601
CON
RES R39004
CON
AND @R605
SET @R709
CON
ENDS
;ERROR202:Memoryｶｰﾄﾞ書込みエラー
STG @R800
ZRES @R104 @R105
CON
ANB R39004
SET R39004
CON
DW #1000 @DM9
CON
DW #202 @DM1
CON
DW #0 @DM2
CON
SET @R600
CON
JMP @R803
STG @R803
AND @R601
RES @R601
CON
RES R39004
CON
AND @R605
SET @R801
CON
ENDS
END
ENDH
