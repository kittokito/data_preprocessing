DEVICE:53
;MODULE:TIMEUP_ERROR
;MODULE_TYPE:1
;SCRIPT_TYPE:
;OneSystem SupportMacro
;
;-----------------------------------------
;Macro Name 	: 	TIMEUP_ERROR
;Macro Type	:	Self Holding
;Function	:	ﾀｲﾑｱｯﾌﾟｴﾗｰ表示
;-----------------------------------------
;
;Copylight(C) 2011 SEIKO EPSON Corp. All rights reserved.
;引数：
;	V0	=	表示ｸﾞﾙｰﾌﾟ番号			#1〜8		
;	V1	=	ﾀｽｸ番号					#0〜31
;	V2	=	ｾﾝｻｱﾗｰﾑ番号				#0〜4095
;	P9	=	完了ﾘﾚｰ					ﾏｸﾛ終了時ON	(戻り値)
;	
;機能：
;	V2〜V4指定ｾﾝｻ番号にてﾀｲﾑｱｯﾌﾟｴﾗｰ表示、復帰待ち(ﾘﾄﾗｲ処理はﾕｰｻﾞｰが記述する事)
LD Run_Mode              ; _運転ﾓｰﾄﾞ指定
SET P9                   ; Fin_Relay
CON
MEND
LD TRAPDO                ; _非常停止中　ﾓｰﾄﾞﾌﾗｸﾞ
ZRES @R000 @R015
CON
MEND
;<h1/>Argumant Range Check/引数範囲ﾁｪｯｸ
LD< V0 #1                ; Group_No
OR> V0 #8                ; Group_No
OR< V1 #0                ; Task_No
OR> V1 #100              ; Task_No
LD> V1 #31               ; Task_No
AND< V1 #100             ; Task_No
ORL
OR< V2 #0                ; SensorCode
OR> V2 #4095             ; SensorCode
SET MacroDown            ; _ｻﾎﾟｰﾄﾏｸﾛ引数異常発生
CON
SET @R015
;<h1/>Init/初期化
LD @CR2008
ORB @R000
ANB Run_Mode             ; _運転ﾓｰﾄﾞ指定
RES P9                   ; Fin_Relay
SET @R014
;<h1/>Pause Request/ﾎﾟｰｽﾞ要求
;・ﾏｸﾛ実行中にPAUSE要求にてHALT実施
LDB Run_Mode             ; _運転ﾓｰﾄﾞ指定
AND<> V1 #100            ; Task_No
MPS
LDA V0                   ; Group_No
CON
SUB #1
CON
MUL #32
CON
ADD V1                   ; Task_No
CON
STA Z9
MRD
LDA V0                   ; Group_No
CON
SUB #1
CON
STA Z8
MPP
AND PAUSE1:Z8            ; _Grp1 ﾎﾟｰｽﾞ要求
SET HALT1:Z9             ; _Grp1_Task0_ﾎﾟｰｽﾞ許可
;<h1/>Exclusive/排他占有
;・排他解除待ち中にPAUSE要求にてHALT実施
LDB Run_Mode             ; _運転ﾓｰﾄﾞ指定
LDA V0                   ; Group_No
CON
SUB #1
CON
STA Z8
CON
ANB TRAPDO               ; _非常停止中　ﾓｰﾄﾞﾌﾗｸﾞ
ANB SYSEXC_ERR1:Z8       ; _Group1　ｴﾗｰ処理排他
ANB ERROR1:Z8            ; _Group1　ｴﾗｰ発生中
SET SYSEXC_ERR1:Z8       ; _Group1　ｴﾗｰ処理排他
MPS
SET @R000
CON
SET @R001
MPP
AND CR2002               ; 常時ON
RES KtoV_TERR1_DSP:Z8    ; KtoV_TERR1_DSP
;<h1/>Error Code Making/ｴﾗｰｺｰﾄﾞ作成
;ﾀｲﾑｱｯﾌﾟｴﾗｰ番号はｸﾞﾙｰﾌﾟ番号+5000固定
STG @R001
MPS
LDA V0                   ; Group_No
CON
SUB #1
CON
MUL #2
CON
STA Z8
MRD
LDA V0                   ; Group_No
CON
MUL #10000
CON
STA @EM3
MRD
LDA @EM3
CON
ADD #5000
CON
STA @EM4
MRD
MOV @EM4 KtoV_TERR1_ERR:Z8;_ﾀｲﾑｱｯﾌﾟｴﾗｰ　ｴﾗｰ番号
MRD
FMOV #0 KtoV_TERR_ALM #256;_ﾀｲﾑｱｯﾌﾟｴﾗｰ(ID1)ｱﾗｰﾑ検出ﾜｰﾄﾞﾋﾞｯﾄ
MPP
JMP @R002
;<h1/>Error Message Alarm Bit Making/ｴﾗｰﾒｯｾｰｼﾞｱﾗｰﾑﾋﾞｯﾄ作成
STG @R002
AND @R008
RES @R008
CON
JMP @R003
;'センサ番号(アラームID1)ONビット生成
;@EM7 = V2 / 16
;@EM8 = V2 MOD 16
;
;BSET (KtoV_TERR_ALM:@EM7,@EM8)
;
;SET (@R008)
LD @R002
NCJ #1000
;'センサ番号(アラームID1)ONビット生成
;
;@EM7 = V2 / 16
;
LD CR2002                ; 常時ON
LDA V2                   ; SensorCode
CON
EXT
CON
EXT.L
CON
DIV.L +16
CON
STA @EM7
;@EM8 = V2 MOD 16
;
LD CR2002                ; 常時ON
LDA V2                   ; SensorCode
CON
EXT
CON
EXT.L
CON
DIV.L +16
CON
LDA.L TM2
CON
STA @EM8
;BSET (KtoV_TERR_ALM:@EM7,@EM8)
;
LD CR2002                ; 常時ON
LDA @EM7
CON
EXT
CON
STA.L Z12
BSET KtoV_TERR_ALM:Z12 @EM8;_ﾀｲﾑｱｯﾌﾟｴﾗｰ(ID1)ｱﾗｰﾑ検出ﾜｰﾄﾞﾋﾞｯﾄ
;SET (@R008)
LD CR2002                ; 常時ON
SET @R008
LABEL #1000
;
;<h1/>Timeup Error Display/ﾀｲﾑｱｯﾌﾟｴﾗｰ画面表示
STG @R003
MPS
LDA V0                   ; Group_No
CON
SUB #1
CON
STA Z8
CON
SET ERROR1:Z8            ; _Group1　ｴﾗｰ発生中
MPP
TMH @2 #5
CON
AND @T2
SET KtoV_TERR1_OPN:Z8    ; _ﾀｲﾑｱｯﾌﾟｴﾗｰ表示要求
CON
JMP @R004
;<h1/>Timeup Error Release Waiting/ﾀｲﾑｱｯﾌﾟｴﾗｰ解除待ち
;ｴﾗｰ復帰選択肢→STARTｽｲｯﾁ待ち
STG @R004
MPS
LDA V0                   ; Group_No
CON
SUB #1
CON
MUL #2
CON
STA Z10
MRD
LDA V0                   ; Group_No
CON
SUB #1
CON
STA Z8
MPP
LD<> V1 #100             ; Task_No
ANB OPEN1:Z8             ; _安全ｶﾊﾞｰ1開中
ANB AirState1:Z8         ; _Group1 ｴｱｰ元圧状態
ANB AREADO1:Z8           ; _Group1　ｴﾘｱｾﾝｻ遮断中
OR= V1 #100              ; Task_No
AND<> VtoK_TERR1_Ret:Z10 #0;_ﾀｲﾑｱｯﾌﾟｴﾗｰ　復帰選択肢
LD= V0 #1                ; Group_No
ANP START_SW1            ; *Group1　ｽﾀｰﾄSW
LD= V0 #2                ; Group_No
ANP START_SW2            ; *Group2　ｽﾀｰﾄSW
ORL
LD= V0 #3                ; Group_No
ANP START_SW3            ; *Group3　ｽﾀｰﾄSW
ORL
LD= V0 #4                ; Group_No
ANP START_SW4            ; *Group4　ｽﾀｰﾄSW
ORL
LD= V0 #5                ; Group_No
ANP START_SW5            ; *Group5　ｽﾀｰﾄSW
ORL
LD= V0 #6                ; Group_No
ANP START_SW6            ; *Group6　ｽﾀｰﾄSW
ORL
LD= V0 #7                ; Group_No
ANP START_SW7            ; *Group7　ｽﾀｰﾄSW
ORL
LD= V0 #8                ; Group_No
ANP START_SW8            ; *Group8　ｽﾀｰﾄSW
ORL
ANL
ANL
JMP @R005
;<h1/>Return Choise Switch Check/復帰選択肢格納
;ﾀｲﾑｱｯﾌﾟｴﾗｰ復帰選択肢はﾘﾄﾗｲのみ
STG @R005
MPS
LDA V0                   ; Group_No
CON
SUB #1
CON
MUL #2
CON
STA Z10
MPP
AND= VtoK_TERR1_Ret:Z10 #1;_ﾀｲﾑｱｯﾌﾟｴﾗｰ　復帰選択肢
LDA V0                   ; Group_No
CON
SUB #1
CON
STA Z8
CON
RES KtoV_TERR1_OPN:Z8    ; _ﾀｲﾑｱｯﾌﾟｴﾗｰ表示要求
CON
JMP @R006
;<h1/>Data Collection Making/ﾃﾞｰﾀ収集用ﾃﾞｰﾀ作成
;・ｴﾗｰｺｰﾄﾞ
;・停止時間
;・ｴﾗｰ選択肢番号
;・ｾﾝｻｱﾗｰﾑｺｰﾄﾞ
;・ｴﾗｰ復帰
;///Ver1.0.2///
;・データ収集エラー復帰選択肢格納(DC_Err*Ret)に選択肢が格納されない不具合修正
STG @R006
MPS
LDA V0                   ; Group_No
CON
SUB #1
CON
MUL #12
CON
STA Z7
MRD
MOV @EM4 DC_Err1Code:Z7  ; _ﾃﾞｰﾀ収集　ｴﾗｰｺｰﾄﾞ
MRD
MOV.D @EM5 DC_Err1Time:Z7; _ﾃﾞｰﾀ収集　停止時間
MRD
MOV #1 DC_Err1Ret:Z7     ; _ﾃﾞｰﾀ収集　復帰ｽｲｯﾁ番号
MRD
MOV V2 DC_Err1Sns1:Z7    ; SensorCode  _ﾃﾞｰﾀ収集　ｾﾝｻｱﾗｰﾑ番号1
MRD
SET DC_ErrRet:Z8         ; _ﾃﾞｰﾀ収集　通常ｴﾗｰ解除
MPP
RES @R014
CON
JMP @R007
;<h1/>End Process/終了処理
STG @R007
MPS
LDA V0                   ; Group_No
CON
SUB #1
CON
MUL #20
CON
STA Z9
MRD
LDA V0                   ; Group_No
CON
SUB #1
CON
MUL #2
CON
STA Z10
MRD
LDA V0                   ; Group_No
CON
SUB #1
CON
STA Z8
MPP
AND<> DM3000:Z9 #1010    ; _MainTP　表示中ﾍﾟｰｼﾞNo
FMOV #0 KtoV_TERR_ALM #256;_ﾀｲﾑｱｯﾌﾟｴﾗｰ(ID1)ｱﾗｰﾑ検出ﾜｰﾄﾞﾋﾞｯﾄ
MPS
DW #0 VtoK_TERR1_Ret:Z10 ; _ﾀｲﾑｱｯﾌﾟｴﾗｰ　復帰選択肢
CON
RES KtoV_TERR1_DSP:Z8    ; KtoV_TERR1_DSP
CON
RES ERROR1:Z8            ; _Group1　ｴﾗｰ発生中
CON
RES SYSEXC_ERR1:Z8       ; _Group1　ｴﾗｰ処理排他
MRD
SET P9                   ; Fin_Relay
MRD
MEND
MPP
RES @R000
CON
ENDS
;<h1/>Error Time Record/ｴﾗｰ停止時間計測
LD @R014
MPS
ANB @T1
TMS @1 #4294967295
MPP
LDA.D #4294967295
CON
SUB.D @T1
CON
STA.D @EM5
END
ENDH
