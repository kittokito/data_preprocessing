DEVICE:53
;MODULE:FFU_READ
;MODULE_TYPE:1
;SCRIPT_TYPE:
;OneSystem SupportMacro
;
;-----------------------------------------
;Macro Name 	: 　FFU_READ
;Macro Type	:	Self Holding
;Function	:	OMRON ZN-J SERIES
;-----------------------------------------
;引数：
;	V0	=	FFU機器番号			　実数で指定			V0 = FFU Node Address
;	P0  =   先頭R　　　　　　	 R番号で指定(2ch占有)	P0 = Input Leading Address for KV-L20V
;	P1	=	先頭DM	　　　　	DM番号で指定(600点占有)	P1 = Output Leading Address for KV-L20V
;	P2  =   完了ｺｰﾄﾞ			DM番号で指定　	　　　　P2 = Macro Complete Code
;			#20 	= 正常終了							#20 = No Error
;			#21 	= 応答なし					　　	#21 = Non Responce
;			#22 	= 風量異常					　　	#22 = Airflow Abnormal
;			#23 	= 処理ｴﾗｰ							#23 = Processing error
;			#24 	= 通信ｴﾗｰ							#24 = Communication fault
;			#25　　 = 受信ﾃﾞｰﾀ異常　　　　　　　　　　　#25 = Recieve Data Abnormal
;機能：
;	OMRON ZN-J ｼﾘｰｽﾞ 状態確認 to Keyence KV-L21V 通信用Macro
;Rev：1.0
;非常停止　/　Emergency Stop
LD R50010                ; Emergency　Stop
ZRES @MR000 @MR115       ; End
CON
MEND
;初期化　/ Initialize
LD @CR2008
ZRES P0:#16 P0:#18       ; Address_R  Address_R
CON
ZRES P1:#0 P1:#522       ; Address_DM  Address_DM
CON
DW #0 P2                 ; Result_Code
CON
ZRES @MR000 @MR115       ; End
CON
SET @MR000
;受信ﾊﾞｯﾌｧｸﾘｱ ：ｺﾏﾝﾄﾞ送信前にL21V内に受信ﾊﾞｯﾌｧがあればｸﾘｱする
STG @MR000
MPS
AND P0:#2                ; Address_R
SET P0:#18               ; Address_R
CON
JMP @MR001
MPP
ANB P0:#2                ; Address_R
JMP @MR003
STG @MR001
ANB P0:#2                ; Address_R
RES P0:#18               ; Address_R
CON
JMP @MR002
STG @MR002
TMH @0 #1
CON
AND @T0
JMP @MR003
STG @MR003
SET @MR012               ; Initialize
CON
JMP @MR004
;                  '<<  通信の初期設定  >>
;P1:#515 = $0  	  'Port2 ﾃﾞｰﾀ格納単位設定   (0:ﾊﾞｲﾄ単位)
;P1:#516 = $0	  'Port2 ﾓｰﾄﾞ設定           (0:ﾉｰﾏﾙﾓｰﾄﾞ)
;P1:#518 = $0200	  'Port2 送信ﾍｯﾀﾞ設定       (02:STX)
;P1:#519 = $0300	  'Port2 送信ﾃﾞﾘﾐﾀ設定      (03:ETX)
;P1:#520 = $0200	  'Port2 受信ﾍｯﾀﾞ設定       (02:STX)
;P1:#521 = $0300	  'Port2 受信ﾃﾞﾘﾐﾀ設定      (03:ETX)
;P1:#522 = #512    'Port2 受信ﾃﾞｰﾀ長さ      （512）
;RES(@MR012)
LD @MR012                ; Initialize
NCJ #1000
;                  '<<  通信の初期設定  >>
;
;P1:#515 = $0  	  'Port2 ﾃﾞｰﾀ格納単位設定   (0:ﾊﾞｲﾄ単位)
;
LD CR2002                ; 常時ON
MOV $0000 P1:#515        ; Address_DM
;P1:#516 = $0	  'Port2 ﾓｰﾄﾞ設定           (0:ﾉｰﾏﾙﾓｰﾄﾞ)
;
LD CR2002                ; 常時ON
MOV $0000 P1:#516        ; Address_DM
;P1:#518 = $0200	  'Port2 送信ﾍｯﾀﾞ設定       (02:STX)
;
LD CR2002                ; 常時ON
MOV $0200 P1:#518        ; Address_DM
;P1:#519 = $0300	  'Port2 送信ﾃﾞﾘﾐﾀ設定      (03:ETX)
;
LD CR2002                ; 常時ON
MOV $0300 P1:#519        ; Address_DM
;P1:#520 = $0200	  'Port2 受信ﾍｯﾀﾞ設定       (02:STX)
;
LD CR2002                ; 常時ON
MOV $0200 P1:#520        ; Address_DM
;P1:#521 = $0300	  'Port2 受信ﾃﾞﾘﾐﾀ設定      (03:ETX)
;
LD CR2002                ; 常時ON
MOV $0300 P1:#521        ; Address_DM
;P1:#522 = #512    'Port2 受信ﾃﾞｰﾀ長さ      （512）
;
LD CR2002                ; 常時ON
MOV #512 P1:#522         ; Address_DM
;RES(@MR012)
LD CR2002                ; 常時ON
RES @MR012               ; Initialize
LABEL #1000
;
STG @MR004
ANB @MR012               ; Initialize
SET P0:#16               ; Address_R
CON
JMP @MR100               ; Data transmission
;ﾃｷｽﾄﾃﾞｰﾀ送信　/　Data transmission
STG @MR100               ; Data transmission
SET @MR112
CON
JMP @MR101
;P1:#1   = 19	  'ﾃﾞｰﾀ長
;                  '<<  送信ﾃﾞｰﾀの格納  "STX DC1 0 13 0 0 41 0 0 0 0 40 01 ETX 22"  >>
;P1:#2   = $0211	  'STX DC1
;P1:#3   = $3031   '01
;P1:#4   = $3330   '30
;P1:#5   = $3034   '04
;
;SELECT CASE V0
;CASE 1
;	P1:#6   = $3130   '10
;CASE 2
;	P1:#6   = $3230   '20
;CASE 3
;	P1:#6   = $3330   '30
;CASE 4
;	P1:#6   = $3430   '40
;CASE 5
;	P1:#6   = $3530   '50
;CASE 6
;	P1:#6   = $3630   '60
;CASE 7
;	P1:#6   = $3730   '70
;CASE 8
;	P1:#6   = $3830   '80
;CASE 9
;	P1:#6   = $3930   '90
;CASE ELSE
;	P1:#6   = $3030   '00
;END SELECT
;
;P1:#7   = $3030   '00
;P1:#8   = $3034   '04
;P1:#9   = $3030   '00
;P1:#10  = $3003   '0 ETX
;
;SELECT CASE V0
;CASE 1
;	P1:#11  = $2300   'BCC(23)
;CASE 2
;	P1:#11  = $2000   'BCC(20)
;CASE 3
;	P1:#11  = $2100   'BCC(21)
;CASE 4
;	P1:#11  = $2600   'BCC(26)
;CASE 5
;	P1:#11  = $2700   'BCC(27)
;CASE 6
;	P1:#11  = $2400   'BCC(24)
;CASE 7
;	P1:#11  = $2500   'BCC(25)
;CASE 8
;	P1:#11  = $2600   'BCC(26)
;CASE 9
;	P1:#11  = $2A00   'BCC(2A)
;CASE ELSE
;	P1:#11  = $2B00   'BCC(2B)
;END SELECT
;
;RES(@MR112)
LD @MR112
NCJ #1002
;P1:#1   = 19	  'ﾃﾞｰﾀ長
;
LD CR2002                ; 常時ON
MOV #19 P1:#1            ; Address_DM
;                  '<<  送信ﾃﾞｰﾀの格納  "STX DC1 0 13 0 0 41 0 0 0 0 40 01 ETX 22"  >>
;
;P1:#2   = $0211	  'STX DC1
;
LD CR2002                ; 常時ON
MOV $0211 P1:#2          ; Address_DM
;P1:#3   = $3031   '01
;
LD CR2002                ; 常時ON
MOV $3031 P1:#3          ; Address_DM
;P1:#4   = $3330   '30
;
LD CR2002                ; 常時ON
MOV $3330 P1:#4          ; Address_DM
;P1:#5   = $3034   '04
;
LD CR2002                ; 常時ON
MOV $3034 P1:#5          ; Address_DM
;SELECT CASE V0
;
LD CR2002                ; 常時ON
MOV V0 @VM0              ; FFU_No.
;CASE 1
;
LD= @VM0 #1
NCJ #2000
;	P1:#6   = $3130   '10
;
LD CR2002                ; 常時ON
MOV $3130 P1:#6          ; Address_DM
LD CR2002                ; 常時ON
CJ #2001
LABEL #2000
;CASE 2
;
LD= @VM0 #2
NCJ #2002
;	P1:#6   = $3230   '20
;
LD CR2002                ; 常時ON
MOV $3230 P1:#6          ; Address_DM
LD CR2002                ; 常時ON
CJ #2003
LABEL #2002
;CASE 3
;
LD= @VM0 #3
NCJ #2004
;	P1:#6   = $3330   '30
;
LD CR2002                ; 常時ON
MOV $3330 P1:#6          ; Address_DM
LD CR2002                ; 常時ON
CJ #2005
LABEL #2004
;CASE 4
;
LD= @VM0 #4
NCJ #2006
;	P1:#6   = $3430   '40
;
LD CR2002                ; 常時ON
MOV $3430 P1:#6          ; Address_DM
LD CR2002                ; 常時ON
CJ #2007
LABEL #2006
;CASE 5
;
LD= @VM0 #5
NCJ #2008
;	P1:#6   = $3530   '50
;
LD CR2002                ; 常時ON
MOV $3530 P1:#6          ; Address_DM
LD CR2002                ; 常時ON
CJ #2009
LABEL #2008
;CASE 6
;
LD= @VM0 #6
NCJ #2010
;	P1:#6   = $3630   '60
;
LD CR2002                ; 常時ON
MOV $3630 P1:#6          ; Address_DM
LD CR2002                ; 常時ON
CJ #2011
LABEL #2010
;CASE 7
;
LD= @VM0 #7
NCJ #2012
;	P1:#6   = $3730   '70
;
LD CR2002                ; 常時ON
MOV $3730 P1:#6          ; Address_DM
LD CR2002                ; 常時ON
CJ #2013
LABEL #2012
;CASE 8
;
LD= @VM0 #8
NCJ #2014
;	P1:#6   = $3830   '80
;
LD CR2002                ; 常時ON
MOV $3830 P1:#6          ; Address_DM
LD CR2002                ; 常時ON
CJ #2015
LABEL #2014
;CASE 9
;
LD= @VM0 #9
NCJ #2016
;	P1:#6   = $3930   '90
;
LD CR2002                ; 常時ON
MOV $3930 P1:#6          ; Address_DM
LD CR2002                ; 常時ON
CJ #2017
LABEL #2016
;CASE ELSE
;
;	P1:#6   = $3030   '00
;
LD CR2002                ; 常時ON
MOV $3030 P1:#6          ; Address_DM
;END SELECT
;
LABEL #2017
LABEL #2015
LABEL #2013
LABEL #2011
LABEL #2009
LABEL #2007
LABEL #2005
LABEL #2003
LABEL #2001
;P1:#7   = $3030   '00
;
LD CR2002                ; 常時ON
MOV $3030 P1:#7          ; Address_DM
;P1:#8   = $3034   '04
;
LD CR2002                ; 常時ON
MOV $3034 P1:#8          ; Address_DM
;P1:#9   = $3030   '00
;
LD CR2002                ; 常時ON
MOV $3030 P1:#9          ; Address_DM
;P1:#10  = $3003   '0 ETX
;
LD CR2002                ; 常時ON
MOV $3003 P1:#10         ; Address_DM
;SELECT CASE V0
;
LD CR2002                ; 常時ON
MOV V0 @VM1              ; FFU_No.
;CASE 1
;
LD= @VM1 #1
NCJ #2018
;	P1:#11  = $2300   'BCC(23)
;
LD CR2002                ; 常時ON
MOV $2300 P1:#11         ; Address_DM
LD CR2002                ; 常時ON
CJ #2019
LABEL #2018
;CASE 2
;
LD= @VM1 #2
NCJ #2020
;	P1:#11  = $2000   'BCC(20)
;
LD CR2002                ; 常時ON
MOV $2000 P1:#11         ; Address_DM
LD CR2002                ; 常時ON
CJ #2021
LABEL #2020
;CASE 3
;
LD= @VM1 #3
NCJ #2022
;	P1:#11  = $2100   'BCC(21)
;
LD CR2002                ; 常時ON
MOV $2100 P1:#11         ; Address_DM
LD CR2002                ; 常時ON
CJ #2023
LABEL #2022
;CASE 4
;
LD= @VM1 #4
NCJ #2024
;	P1:#11  = $2600   'BCC(26)
;
LD CR2002                ; 常時ON
MOV $2600 P1:#11         ; Address_DM
LD CR2002                ; 常時ON
CJ #2025
LABEL #2024
;CASE 5
;
LD= @VM1 #5
NCJ #2026
;	P1:#11  = $2700   'BCC(27)
;
LD CR2002                ; 常時ON
MOV $2700 P1:#11         ; Address_DM
LD CR2002                ; 常時ON
CJ #2027
LABEL #2026
;CASE 6
;
LD= @VM1 #6
NCJ #2028
;	P1:#11  = $2400   'BCC(24)
;
LD CR2002                ; 常時ON
MOV $2400 P1:#11         ; Address_DM
LD CR2002                ; 常時ON
CJ #2029
LABEL #2028
;CASE 7
;
LD= @VM1 #7
NCJ #2030
;	P1:#11  = $2500   'BCC(25)
;
LD CR2002                ; 常時ON
MOV $2500 P1:#11         ; Address_DM
LD CR2002                ; 常時ON
CJ #2031
LABEL #2030
;CASE 8
;
LD= @VM1 #8
NCJ #2032
;	P1:#11  = $2600   'BCC(26)
;
LD CR2002                ; 常時ON
MOV $2600 P1:#11         ; Address_DM
LD CR2002                ; 常時ON
CJ #2033
LABEL #2032
;CASE 9
;
LD= @VM1 #9
NCJ #2034
;	P1:#11  = $2A00   'BCC(2A)
;
LD CR2002                ; 常時ON
MOV $2A00 P1:#11         ; Address_DM
LD CR2002                ; 常時ON
CJ #2035
LABEL #2034
;CASE ELSE
;
;	P1:#11  = $2B00   'BCC(2B)
;
LD CR2002                ; 常時ON
MOV $2B00 P1:#11         ; Address_DM
;END SELECT
;
LABEL #2035
LABEL #2033
LABEL #2031
LABEL #2029
LABEL #2027
LABEL #2025
LABEL #2023
LABEL #2021
LABEL #2019
;RES(@MR112)
LD CR2002                ; 常時ON
RES @MR112
LABEL #1002
;
STG @MR101
ANB @MR112
TMH @1 #5
CON
AND @T1
SET P0:#17               ; Address_R
CON
JMP @MR102
STG @MR102
AND P0:#1                ; Address_R
ANB P0:#6                ; Address_R
RES P0:#17               ; Address_R
CON
JMP @MR103
STG @MR103
MPS
AND P0:#2                ; Address_R
RES @MR109               ; ﾘﾄﾗｲﾌﾗｸﾞ
CON
JMP @MR104
MPP
ANB P0:#2                ; Address_R
TMH @2 #500
CON
AND @T2
MPS
AND @MR109               ; ﾘﾄﾗｲﾌﾗｸﾞ
JMP @MR106               ; Non Responce
MPP
ANB @MR109               ; ﾘﾄﾗｲﾌﾗｸﾞ
JMP @MR110
STG @MR110
SET @MR109               ; ﾘﾄﾗｲﾌﾗｸﾞ
CON
JMP @MR101
STG @MR104
SET P0:#18               ; Address_R
CON
MPS
AND>= P1:#271 $3100      ; Address_DM
JMP @MR105               ; Non Error
MPP
AND< P1:#271 $3100       ; Address_DM
JMP @MR108               ; Airflow Abnormal
;正常終了　/　No Error
STG @MR105               ; Non Error
ANB P0:#2                ; Address_R
RES P0:#16               ; Address_R
CON
RES P0:#18               ; Address_R
CON
DW #20 P2                ; Result_Code
CON
JMP @MR115               ; End
;#21 応答なし　：　一定時間経過してもﾃﾞｰﾀを受信できなかった場合ON
STG @MR106               ; Non Responce
RES @MR109               ; ﾘﾄﾗｲﾌﾗｸﾞ
CON
SET P0:#17               ; Address_R
CON
JMP @MR107
STG @MR107
AND P0:#1                ; Address_R
ANB P0:#6                ; Address_R
RES P0:#16               ; Address_R
CON
RES P0:#17               ; Address_R
CON
RES P0:#18               ; Address_R
CON
DW #21 P2                ; Result_Code
CON
JMP @MR115               ; End
;#22 風量異常　：　FFUの風量が0だった場合ON
STG @MR108               ; Airflow Abnormal
ANB P0:#2                ; Address_R
RES P0:#16               ; Address_R
CON
RES P0:#18               ; Address_R
CON
DW #22 P2                ; Result_Code
CON
JMP @MR115               ; End
;#23 処理ｴﾗｰ　：　外部機器からの受信したﾃﾞｰﾀを処理しきれなくなった場合ON
LDP P0:#3                ; Address_R
RES P0:#16               ; Address_R
CON
RES P0:#17               ; Address_R
CON
RES P0:#18               ; Address_R
CON
DW #23 P2                ; Result_Code
CON
SET @MR115               ; End
;#24 通信ｴﾗｰ　：　通信ｴﾗｰが発生した場合ON
LDP P0:#4                ; Address_R
RES P0:#16               ; Address_R
CON
RES P0:#17               ; Address_R
CON
RES P0:#18               ; Address_R
CON
DW #24 P2                ; Result_Code
CON
SET @MR115               ; End
;#25 設定ﾃﾞｰﾀｴﾗｰ　：　通信設定用のﾃﾞｰﾀﾒﾓﾘのﾃﾞｰﾀが適切でない場合ON
LDP P0:#6                ; Address_R
RES P0:#16               ; Address_R
CON
RES P0:#17               ; Address_R
CON
RES P0:#18               ; Address_R
CON
DW #25 P2                ; Result_Code
CON
SET @MR115               ; End
;終了　/　End
STG @MR115               ; End
ZRES @MR000 @MR115       ; End
CON
ENDS
MEND
END
ENDH
