DEVICE:53
;MODULE:FLAT_COM
;MODULE_TYPE:0
;SCRIPT_TYPE:
;PCとの通信
LDP R46104               ; _非常停止中　ﾓｰﾄﾞﾌﾗｸﾞ
ZRES @MR100 @MR515
;<h1/>通信 MAIN
;ｺﾏﾝﾄﾞ番号説明
;#0		ﾃﾞｰﾀ要求
;#1		受信ﾃﾞｰﾀOK
;#2		受信ﾃﾞｰﾀNG
;#3		
;#4		
;#5		自動ﾓｰﾄﾞ
;#6		手動ﾓｰﾄﾞ
;#7		ﾒﾝﾃﾓｰﾄﾞ
;#8		-
;#9		-
;#10		機種00
;#11		機種01
;#12		機種02
;#13		機種03
;#14		機種04
;#15		機種05
;#16		機種06
;#17		機種07
;#18		機種08
;#19		機種09
;#20		機種10
;#21		
;#22		
;#23		
;#99		
STG R37000               ; PC通信START
ZRES DM54259 DM54514
CON
RES @MR501               ; COM_Finish
CON
SET R37002               ; LK-G通信中
CON
ZRES @DM0 @DM12          ; 格納単位  送信STEP
CON
ZRES @DM16 @DM999
CON
JMP @MR100
STG @MR100
LDA EM1903               ; 送受信種別(1:送信 2:受信)
CON
STA @DM7                 ; 送受信種別(01:送信 02:受信)
CON
MPS
AND= EM1903 #1           ; 送受信種別(1:送信 2:受信)
LDA EM1920               ; 平坦測定通信ｺｰﾄﾞ番号
CON
STA @DM50                ; 通信ｺｰﾄﾞ
CON
JMP @MR101
MPP
AND= EM1903 #2           ; 送受信種別(1:送信 2:受信)
JMP @MR102
;<<送信用>>
STG @MR101
MPS
AND= #0 @DM50            ; 通信ｺｰﾄﾞ
SMOV "00" @DM100         ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MRD
AND= #1 @DM50            ; 通信ｺｰﾄﾞ
SMOV "00OK" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MRD
AND= #2 @DM50            ; 通信ｺｰﾄﾞ
SMOV "00NG" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MRD
AND= #5 @DM50            ; 通信ｺｰﾄﾞ
SMOV "0100" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MRD
AND= #6 @DM50            ; 通信ｺｰﾄﾞ
SMOV "0101" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MRD
AND= #7 @DM50            ; 通信ｺｰﾄﾞ
SMOV "0102" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MRD
AND= #10 @DM50           ; 通信ｺｰﾄﾞ
SMOV "0200" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MRD
AND= #11 @DM50           ; 通信ｺｰﾄﾞ
SMOV "0201" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MRD
AND= #12 @DM50           ; 通信ｺｰﾄﾞ
SMOV "0202" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MRD
AND= #13 @DM50           ; 通信ｺｰﾄﾞ
SMOV "0203" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MRD
AND= #14 @DM50           ; 通信ｺｰﾄﾞ
SMOV "0204" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MRD
AND= #15 @DM50           ; 通信ｺｰﾄﾞ
SMOV "0205" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MRD
AND= #16 @DM50           ; 通信ｺｰﾄﾞ
SMOV "0206" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MRD
AND= #17 @DM50           ; 通信ｺｰﾄﾞ
SMOV "0207" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MRD
AND= #18 @DM50           ; 通信ｺｰﾄﾞ
SMOV "0208" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
MPP
AND= #19 @DM50           ; 通信ｺｰﾄﾞ
SMOV "0209" @DM100       ; 送信ﾃﾞｰﾀ先頭
JMP @MR200               ; 汎用通信
;<<受信用>>
STG @MR102
JMP @MR200               ; 汎用通信
;<h1/>汎用通信
STG @MR200               ; 汎用通信
ANB @MR502               ; 通信中
SET @MR500               ; SERIAL_COM START
CON
JMP @MR201
STG @MR201
AND @MR501               ; COM_Finish
MPS
ANB @MR503               ; COM_Err
RES @MR501               ; COM_Finish
CON
JMP @MR205
MPP
AND @MR503               ; COM_Err
RES @MR501               ; COM_Finish
CON
JMP @MR202
STG @MR202
SET R37003               ; 平坦測定通信異常
CON
RES @MR503               ; COM_Err
CON
JMP @MR205
STG @MR205
SET R37001               ; 平坦測定通信完了
CON
RES R37002               ; LK-G通信中
CON
ENDS
;<h1/>SERIAL通信START
;'SERIAL_COM ﾏｸﾛ使用する為に以下の設定を行う
;@DM0 = $0000	'ﾃﾞｰﾀ格納単位設定
;@DM1 = $0000	'ﾓｰﾄﾞ設定
;@DM2 = #0000	'ﾀｲﾑｱｳﾄﾁｪｯｸ時間設定
;@DM3 = $0000	'送信用ﾍｯﾀﾞ設定
;@DM4 = $0D00	'送信用ﾃﾞﾘﾐﾀ設定
;@DM5 = $0000	'受信用ﾍｯﾀﾞ設定
;@DM6 = $0D00	'受信用ﾃﾞﾘﾐﾀ設定
LD CR2002                ; 常時ON
NCJ #1000
;'SERIAL_COM ﾏｸﾛ使用する為に以下の設定を行う
;
;@DM0 = $0000	'ﾃﾞｰﾀ格納単位設定
;
LD CR2002                ; 常時ON
MOV $0000 @DM0           ; 格納単位
;@DM1 = $0000	'ﾓｰﾄﾞ設定
;
LD CR2002                ; 常時ON
MOV $0000 @DM1           ; ﾓｰﾄﾞ設定
;@DM2 = #0000	'ﾀｲﾑｱｳﾄﾁｪｯｸ時間設定
;
LD CR2002                ; 常時ON
MOV #0 @DM2              ; ﾀｲﾑｱｳﾄ設定
;@DM3 = $0000	'送信用ﾍｯﾀﾞ設定
;
LD CR2002                ; 常時ON
MOV $0000 @DM3           ; 送信ﾍｯﾀﾞ
;@DM4 = $0D00	'送信用ﾃﾞﾘﾐﾀ設定
;
LD CR2002                ; 常時ON
MOV $0D00 @DM4           ; 送信ﾃﾞﾘﾐﾀ
;@DM5 = $0000	'受信用ﾍｯﾀﾞ設定
;
LD CR2002                ; 常時ON
MOV $0000 @DM5           ; 受信ﾍｯﾀﾞ
;@DM6 = $0D00	'受信用ﾃﾞﾘﾐﾀ設定
LD CR2002                ; 常時ON
MOV $0D00 @DM6           ; 送信ﾃﾞﾘﾐﾀ
LABEL #1000
;
STG @MR500               ; SERIAL_COM START
SET @MR502               ; 通信中
CON
DW #0 @DM10              ; 結果ｺｰﾄﾞ
CON
JMP @MR504
LDP @MR504
MSTRT SERIAL_N_COM R24000 DM54000 @DM0 @DM100 @DM500 @DM10;軸1 軸ｴﾗｰｸﾘｱ  ﾕﾆｯﾄｴﾗｰ番号  格納単位  送信ﾃﾞｰﾀ先頭  受信先頭ﾃﾞｰﾀ  結果ｺｰﾄﾞ
STG @MR504
MPS
AND= @DM10 #20           ; 結果ｺｰﾄﾞ
JMP @MR505
MPP
LD<> @DM10 #20           ; 結果ｺｰﾄﾞ
AND<> @DM10 #0           ; 結果ｺｰﾄﾞ
ANL
SET @MR503               ; COM_Err
CON
JMP @MR515
;測定ﾃﾞｰﾀ保管処理分岐
STG @MR505
MPS
AND= EM1903 #1           ; 送受信種別(1:送信 2:受信)
JMP @MR515
MPP
AND= EM1903 #2           ; 送受信種別(1:送信 2:受信)
@FMOV #0 EM30010 #90     ; 制御ｺﾏﾝﾄﾞ
@BMOV DM54259 EM30010 #90; 制御ｺﾏﾝﾄﾞ
JMP @MR515
STG @MR515
TMS @0 #10               ; 通信間隔ﾀｲﾏ
CON
AND @T0                  ; 通信間隔ﾀｲﾏ
SET @MR501               ; COM_Finish
CON
RES @MR502               ; 通信中
CON
ENDS
END
ENDH
