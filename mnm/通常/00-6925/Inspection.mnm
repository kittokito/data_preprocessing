DEVICE:52
;MODULE:Inspection
;MODULE_TYPE:0
;SCRIPT_TYPE:
;2017/04/25
;Work clamp detection ERR adition(SQ-1102) (Always check during Inspection)
;ワーククランプ検出エラー(SQ-1102) 追加(検査中、常時監視)
LD CR2002                ; 常時ON
LD= EM30080 #0           ; 機種番号
ANF R1101                ; 流路ベース クランプ下降端
LD= EM30080 #4           ; 機種番号
ANF R1102                ; サブタンク クランプ下降端
ORL
ANL
ANB MR304                ; ｴﾗｰﾌﾗｸﾞ
ZRES @MR500 @MR2500      ; 検査NGフラグ
CON
SET MR302                ; 検査NG_ｸﾗﾝﾌﾟ異常
;2017/09/05
;エリアセンサ監視追加
LD MR2115                ; エリアセンサランプ
ANF R1115                ; エリアセンサ(通常ON)
ANB MR304                ; ｴﾗｰﾌﾗｸﾞ
ZRES @MR500 @MR2500      ; 検査NGフラグ
CON
SET MR312                ; エリアセンサ遮光
;Initialize setting value
;設定値初期化
LD @CR2008
FMOV #0 EM1 #99          ; 日付〔year〕
FMOV #0 EM1000 #1000     ; 初期圧
FMOV #0 EM10000 #15000   ; ﾘｰｸ検査 圧力ﾃﾞｰﾀ
FMOV #0 EM40000 #15000   ; 検査ﾃﾞｰﾀ 一時保存場所
FMOV #0 FM0 #15000
MPS
ZRES @MR500 @MR2500      ; 検査NGフラグ
CON
DW #0 DM315              ; ﾘｰｸ検査ｴﾗｰ位置記憶
MPP
SET @MR1000
LD EM30014.0
OUT @MR000               ; ｴﾗｰ表示遅延ﾌﾗｸﾞ
LDB @MR000               ; ｴﾗｰ表示遅延ﾌﾗｸﾞ
ANP @MR500               ; 検査NGフラグ
SET MR306                ; 検査NG
LDP MR109                ; 検査強制終了
DW #500 EM30001          ; (TP)ﾍﾟｰｼﾞ画面切替用No.
CON
RES MR110                ; 検査中
CON
ZRES @MR500 @MR2500      ; 検査NGフラグ
;<<リーク検査>>
;<<Leake Inspection>>
STG @MR1000
MOV #0 @DM10             ; ループカウント
MOV #0 @DM11             ; 検査回数
MOV #0 EM39999           ; ﾒﾓﾘｰｶｰﾄﾞ書込みデータ回数
MPS
LDA EM30081              ; 機種選択 アドレスオフセット
CON
EXT
CON
STA.D Z2
CON
BMOV.D DM1000:Z2 @DM200 #50;流路キャップベースコマンド1
BMOV.D DM4000:Z2 @DM300 #50;流路キャップベース経路加圧_時間
MPP
TMS @2 #10
CON
AND @T2
JMP @MR1001
STG @MR1001
LD= EM30080 #1           ; 機種番号
OR= EM30080 #2           ; 機種番号
OR= EM30080 #3           ; 機種番号
OR= EM30080 #5           ; 機種番号
OR= EM30080 #0           ; 機種番号
OR= EM30080 #4           ; 機種番号
ANL
JMP @MR1100
STG @MR1100
MPS
LDA @DM10                ; ループカウント
CON
EXT
CON
MUL.D #2
CON
STA.D Z3
CON
MOV.D @DM200:Z3 @DM0     ; 各ステップデータ
MOV.D @DM300:Z3 @DM8     ; 各ステップパラメータ(時間)
MRD
AND MR107                ; 全データ取得フラグ
SET @MR2000
MPP
JMP @MR1101
;@DM2.D = ANDA(@DM0.D,$00FFFFFF)		'IO情報のみ取り出し
;@DM4.D = SLA(@DM2.D,8)				'IO割り付けに合わせシフト
;@DM6.D = ANDA(MR2000.D , $E00000FF)'現在の出力(バルブ以外)を取り出し
;MR2000.D = ORA(@DM4.D ,@DM6.D)	'出力
LDP @MR1101
ORP @MR200
LD>.D @DM0 $00FFFFFF     ; 各ステップデータ
OR CR2002                ; 常時ON
ANL
NCJ #1000
;@DM2.D = ANDA(@DM0.D,$00FFFFFF)		'IO情報のみ取り出し
;
LD CR2002                ; 常時ON
LDA.D @DM0               ; 各ステップデータ
CON
ANDA.D $00FFFFFF
CON
STA.D @DM2               ; バルブ開閉データ
;@DM4.D = SLA(@DM2.D,8)				'IO割り付けに合わせシフト
;
LD CR2002                ; 常時ON
LDA.D @DM2               ; バルブ開閉データ
CON
SLA.D #8
CON
STA.D @DM4               ; バルブ開閉データ出力用
;@DM6.D = ANDA(MR2000.D , $E00000FF)'現在の出力(バルブ以外)を取り出し
;
LD CR2002                ; 常時ON
LDA.D MR2000             ; スタートスイッチランプ中央
CON
ANDA.D $E00000FF
CON
STA.D @DM6               ; 出力データtmp
;MR2000.D = ORA(@DM4.D ,@DM6.D)	'出力
LD CR2002                ; 常時ON
LDA.D @DM4               ; バルブ開閉データ出力用
CON
ORA.D @DM6               ; 出力データtmp
CON
STA.D MR2000             ; スタートスイッチランプ中央
LABEL #1000
;
STG @MR1101
JMP @MR1102
STG @MR1102
MPS
AND @DM1.8               ; 待機
SET @MR1200              ; 待機
CON
JMP @MR1103
MRD
AND @DM1.9               ; 無し
JMP @MR1103
MRD
LD @DM1.10               ; 初期圧確認
OR @DM1.12               ; 初期圧確認2
ANL
MPS
ANB MR107                ; 全データ取得フラグ
SET @MR1300              ; 初期圧確認
CON
JMP @MR1103
MPP
AND MR107                ; 全データ取得フラグ
JMP @MR1103
MRD
AND @DM1.11              ; 圧力監視
MPS
ANB MR107                ; 全データ取得フラグ
SET @MR1400              ; 圧力監視
CON
JMP @MR1103
MPP
AND MR107                ; 全データ取得フラグ
SET @MR1200              ; 待機
CON
JMP @MR1103
MPP
AND @DM1.15              ; 終了
SET @MR902               ; 終了フラグ
CON
JMP @MR1103
STG @MR1103
LD @MR1201               ; 待機完了
OR @MR1301               ; 初期圧確認完了
OR @MR1401               ; 圧力監視完了
OR @DM1.9                ; 無し
OR @DM1.15               ; 終了
LD @DM1.10               ; 初期圧確認
OR @DM1.12               ; 初期圧確認2
AND MR107                ; 全データ取得フラグ
ORL
ANL
RES @MR1201              ; 待機完了
CON
RES @MR1301              ; 初期圧確認完了
CON
RES @MR1401              ; 圧力監視完了
CON
RES @MR1401              ; 圧力監視完了
CON
MPS
ANB MR304                ; ｴﾗｰﾌﾗｸﾞ
JMP @MR1104
MPP
AND MR304                ; ｴﾗｰﾌﾗｸﾞ
ENDS
STG @MR1104
MPS
ANB @MR902               ; 終了フラグ
INC @DM10                ; ループカウント
CON
JMP @MR1100
MPP
AND @MR902               ; 終了フラグ
JMP @MR1105
STG @MR1105
MPS
ANB @MR500               ; 検査NGフラグ
SET MR200                ; 検査OK
CON
RES MR110                ; 検査中
CON
ENDS
MPP
AND @MR500               ; 検査NGフラグ
SET MR306                ; 検査NG
CON
ENDS
;待機
STG @MR1200              ; 待機
SET @MR1202
CON
JMP @MR1203
STG @MR1203
LDA @DM8                 ; 各ステップパラメータ(時間)
CON
EXT
CON
MUL.L +10
CON
STA.D @DM12              ; 待機時間
CON
JMP @MR1204
STG @MR1204
MPS
AND=.D @DM12 #0          ; 待機時間
DW.D #10 @DM12           ; 待機時間
CON
JMP @MR1205
MPP
AND<>.D @DM12 #0         ; 待機時間
JMP @MR1205
STG @MR1205
TMH @0 @DM12             ; 待機時間  待機時間
CON
AND @T0                  ; 待機時間
JMP @MR1206
STG @MR1206
SET @MR1201              ; 待機完了
CON
RES @MR1202
CON
ENDS
;初期圧取得
STG @MR1300              ; 初期圧確認
SET @MR1302
CON
JMP @MR1303
;@DM70 = 1	'チャンネル番号
;@DM71 = 100	'タイムアウト
;@DM72 = 10	'データ取得時間(未使用)
;@DM73 = EM30020	'データ取得周期
LDP @MR1303
NCJ #1001
;@DM70 = 1	'チャンネル番号
;
LD CR2002                ; 常時ON
MOV #1 @DM70             ; (検査)通信ﾁｬﾝﾈﾙ番号
;@DM71 = 100	'タイムアウト
;
LD CR2002                ; 常時ON
MOV #100 @DM71           ; (検査)通信ﾀｲﾑｱｳﾄ
;@DM72 = 10	'データ取得時間(未使用)
;
LD CR2002                ; 常時ON
MOV #10 @DM72            ; (検査)ﾃﾞｰﾀ取得時間
;@DM73 = EM30020	'データ取得周期
LD CR2002                ; 常時ON
MOV EM30020 @DM73        ; (TP)サンプリング  (検査)ﾃﾞｰﾀ取得周期
LABEL #1001
;
STG @MR1303
DW #0 EM1000             ; 初期圧
CON
DW #0 EM1001
CON
JMP @MR1304
STG @MR1304
SET @MR1315
CON
JMP @MR1305
LDP @MR1315
MSTRT INSPECT_DATA_1 #3 @DM70 EM1000 @MR901 DM145 @MR1315;(検査)通信ﾁｬﾝﾈﾙ番号  初期圧  ｴﾗｰﾌﾗｸﾞ  詳細ｴﾗｰｺｰﾄﾞ
LD @MR1315
AND>= EM1000 #1          ; 初期圧
RES @MR1315
STG @MR1305
ANF _INSPECT_DATA_1
MPS
ANB @MR901               ; ｴﾗｰﾌﾗｸﾞ
JMP @MR1306
MPP
AND @MR901               ; ｴﾗｰﾌﾗｸﾞ
SET MR310                ; 通信ｴﾗｰ
CON
ENDS
;Z4 = @DM11 * 2
;EM30030:Z4 = EM1001 'TP表示、判定用
;
;Z5 = @DM11 * 6
;EM11:Z5 = @DM9		'規格値(初期圧)
;EM13:Z5 = EM1001	'初期圧
;
;
;set(@mr1314)
LDP @MR1306
NCJ #1004
;Z4 = @DM11 * 2
;
LD CR2002                ; 常時ON
LDA @DM11                ; 検査回数
CON
EXT
CON
MUL.L +2
CON
STA.L Z4
;EM30030:Z4 = EM1001 'TP表示、判定用
;
LD CR2002                ; 常時ON
MOV EM1001 EM30030:Z4    ; (TP)Step1 初期圧
;Z5 = @DM11 * 6
;
LD CR2002                ; 常時ON
LDA @DM11                ; 検査回数
CON
EXT
CON
MUL.L +6
CON
STA.L Z5
;EM11:Z5 = @DM9		'規格値(初期圧)
;
LD CR2002                ; 常時ON
MOV @DM9 EM11:Z5         ; 各ステップパラメータ(圧力)  Step1 規格値(初期圧)
;EM13:Z5 = EM1001	'初期圧
;
LD CR2002                ; 常時ON
MOV EM1001 EM13:Z5       ; Step1 初期圧
;set(@mr1314)
LD CR2002                ; 常時ON
SET @MR1314
LABEL #1004
;
STG @MR1306
AND @MR1314
MPS
ANB @DM1.12              ; 初期圧確認2
MPS
AND>=.S EM30030:Z4 @DM9  ; (TP)Step1 初期圧  各ステップパラメータ(圧力)
DW #1 EM30050:Z4         ; (TP)Step1 初期圧判定
CON
RES @MR1314
CON
JMP @MR1307
MPP
AND<.S EM30030:Z4 @DM9   ; (TP)Step1 初期圧  各ステップパラメータ(圧力)
DW #2 EM30050:Z4         ; (TP)Step1 初期圧判定
CON
RES @MR1314
CON
SET @MR500               ; 検査NGフラグ
CON
JMP @MR1307
MPP
AND @DM1.12              ; 初期圧確認2
MPS
LD>=.S EM30030:Z4 @DM9   ; (TP)Step1 初期圧  各ステップパラメータ(圧力)
AND R1006
ANL
DW #1 EM30050:Z4         ; (TP)Step1 初期圧判定
CON
RES @MR1314
CON
JMP @MR1307
MPP
LD<.S EM30030:Z4 @DM9    ; (TP)Step1 初期圧  各ステップパラメータ(圧力)
ORB R1006
ANL
DW #2 EM30050:Z4         ; (TP)Step1 初期圧判定
CON
RES @MR1314
CON
SET @MR500               ; 検査NGフラグ
CON
JMP @MR1307
STG @MR1307
TMH @5 #5                ; 値取得後ディレイ
CON
AND @T5                  ; 値取得後ディレイ
JMP @MR1308
STG @MR1308
JMP @MR1309
STG @MR1309
SET @MR1301              ; 初期圧確認完了
CON
RES @MR1302
CON
ENDS
;圧力監視
STG @MR1400              ; 圧力監視
SET @MR1402
CON
JMP @MR1403
;@DM70 = 1	'チャンネル番号
;@DM71 = 100'タイムアウト
;@DM72 = 100	'データ取得時間(マクロ内未使用)
;@DM73 = EM30020	'データ取得周期
;@DM74.D = @DM8 * 10 'データ取得時間
LDP @MR1403
NCJ #1002
;@DM70 = 1	'チャンネル番号
;
LD CR2002                ; 常時ON
MOV #1 @DM70             ; (検査)通信ﾁｬﾝﾈﾙ番号
;@DM71 = 100'タイムアウト
;
LD CR2002                ; 常時ON
MOV #100 @DM71           ; (検査)通信ﾀｲﾑｱｳﾄ
;@DM72 = 100	'データ取得時間(マクロ内未使用)
;
LD CR2002                ; 常時ON
MOV #100 @DM72           ; (検査)ﾃﾞｰﾀ取得時間
;@DM73 = EM30020	'データ取得周期
;
LD CR2002                ; 常時ON
MOV EM30020 @DM73        ; (TP)サンプリング  (検査)ﾃﾞｰﾀ取得周期
;@DM74.D = @DM8 * 10 'データ取得時間
;;Warning[1103]: "=": (符号付き32ビット整数型->符号無し32ビット整数型) 代入によりデータが欠落する可能性があります。
LD CR2002                ; 常時ON
LDA @DM8                 ; 各ステップパラメータ(時間)
CON
EXT
CON
MUL.L +10
CON
STA.D @DM74              ; データ取得時間
LABEL #1002
;
STG @MR1403
JMP @MR1404
STG @MR1404
SET @MR1415
CON
JMP @MR1405
LDP @MR1415
MSTRT INSPECT_DATA_2 #3 @DM70 EM10000 @MR901 DM145 @MR1415;(検査)通信ﾁｬﾝﾈﾙ番号  ﾘｰｸ検査 圧力ﾃﾞｰﾀ  ｴﾗｰﾌﾗｸﾞ  詳細ｴﾗｰｺｰﾄﾞ
LD _INSPECT_DATA_2
TMH @1 @DM74             ; データ取得時間
CON
AND @T1
RES @MR1415
STG @MR1405
ANF _INSPECT_DATA_2
MPS
ANB @MR901               ; ｴﾗｰﾌﾗｸﾞ
JMP @MR1406
MPP
AND @MR901               ; ｴﾗｰﾌﾗｸﾞ
SET MR310                ; 通信ｴﾗｰ
CON
JMP @MR1413
;Z4 = @DM11 * 2
;EM30031:Z4 = EM30030:Z4 - EM10000:EM10000 'TP表示、判定用
;
;Z5 = @DM11 * 6
;EM12:Z5 = @DM9				'規格値(初期圧)
;EM14:Z5 = EM30031:Z4		'初期圧
;EM15:Z5 = EM10000:EM10000	'最終圧
;
;EM39999 = @DM11 + 1
;FM0:(@DM11 * 1000) = @DM8 / (EM30020 / 10)
;bmov(1,EM10000,FM1:(@DM11 * 1000),1000)
;
;set(@mr1414)
LDP @MR1406
NCJ #1003
;Z4 = @DM11 * 2
;
LD CR2002                ; 常時ON
LDA @DM11                ; 検査回数
CON
EXT
CON
MUL.L +2
CON
STA.L Z4
;EM30031:Z4 = EM30030:Z4 - EM10000:EM10000 'TP表示、判定用
;
;;Warning[1103]: "=": (符号付き32ビット整数型->符号無し16ビット整数型) 代入によりデータが欠落する可能性があります。
LD CR2002                ; 常時ON
LDA EM10000              ; ﾘｰｸ検査 圧力ﾃﾞｰﾀ
CON
EXT
CON
STA.L Z12
CON
LDA EM10000:Z12          ; ﾘｰｸ検査 圧力ﾃﾞｰﾀ
CON
EXT
CON
STA.L @VM0
CON
LDA EM30030:Z4           ; (TP)Step1 初期圧
CON
EXT
CON
SUB.L @VM0
CON
STA EM30031:Z4           ; (TP)Step1 リーク量
;Z5 = @DM11 * 6
;
LD CR2002                ; 常時ON
LDA @DM11                ; 検査回数
CON
EXT
CON
MUL.L +6
CON
STA.L Z5
;EM12:Z5 = @DM9				'規格値(初期圧)
;
LD CR2002                ; 常時ON
MOV @DM9 EM12:Z5         ; 各ステップパラメータ(圧力)  Step1 規格値(ﾘｰｸ量)
;EM14:Z5 = EM30031:Z4		'初期圧
;
LD CR2002                ; 常時ON
MOV EM30031:Z4 EM14:Z5   ; (TP)Step1 リーク量  Step1 ﾘｰｸ量
;EM15:Z5 = EM10000:EM10000	'最終圧
;
LD CR2002                ; 常時ON
LDA EM10000              ; ﾘｰｸ検査 圧力ﾃﾞｰﾀ
CON
EXT
CON
STA.L Z12
CON
MOV EM10000:Z12 EM15:Z5  ; ﾘｰｸ検査 圧力ﾃﾞｰﾀ  Step1 終了圧
;EM39999 = @DM11 + 1
;
;;Warning[1103]: "=": (符号付き32ビット整数型->符号無し16ビット整数型) 代入によりデータが欠落する可能性があります。
LD CR2002                ; 常時ON
LDA @DM11                ; 検査回数
CON
EXT
CON
ADD.L +1
CON
STA EM39999              ; ﾒﾓﾘｰｶｰﾄﾞ書込みデータ回数
;FM0:(@DM11 * 1000) = @DM8 / (EM30020 / 10)
;
;;Warning[1103]: "=": (符号付き32ビット整数型->符号無し16ビット整数型) 代入によりデータが欠落する可能性があります。
LD CR2002                ; 常時ON
LDA @DM11                ; 検査回数
CON
EXT
CON
MUL.L +1000
CON
STA.L Z11
CON
LDA EM30020              ; (TP)サンプリング
CON
EXT
CON
EXT.L
CON
DIV.L +10
CON
STA.L @VM2
CON
LDA @DM8                 ; 各ステップパラメータ(時間)
CON
EXT
CON
EXT.L
CON
DIV.L @VM2
CON
STA FM0:Z11
;bmov(1,EM10000,FM1:(@DM11 * 1000),1000)
;
LD CR2002                ; 常時ON
LDA @DM11                ; 検査回数
CON
EXT
CON
MUL.L +1000
CON
STA.L Z12
LD CR2002                ; 常時ON
BMOV EM10000 FM1:Z12 #1000;ﾘｰｸ検査 圧力ﾃﾞｰﾀ
;set(@mr1414)
LD CR2002                ; 常時ON
SET @MR1414
LABEL #1003
;
STG @MR1406
AND @MR1414
MPS
AND<=.S EM30031:Z4 @DM9  ; (TP)Step1 リーク量  各ステップパラメータ(圧力)
DW #1 EM30051:Z4         ; (TP)Step1 リーク量判定
CON
RES @MR1414
CON
JMP @MR1407
MPP
AND>.S EM30031:Z4 @DM9   ; (TP)Step1 リーク量  各ステップパラメータ(圧力)
DW #2 EM30051:Z4         ; (TP)Step1 リーク量判定
CON
RES @MR1414
CON
SET @MR500               ; 検査NGフラグ
CON
JMP @MR1407
STG @MR1407
INC @DM11                ; 検査回数
CON
JMP @MR1408
STG @MR1408
JMP @MR1409
STG @MR1409
JMP @MR1410
STG @MR1410
JMP @MR1411
STG @MR1411
JMP @MR1412
STG @MR1412
SET @MR1401              ; 圧力監視完了
CON
RES @MR1402
CON
ENDS
STG @MR1413
ENDS
STG @MR2000
SET @MR2015              ; 検査ﾃﾞｰﾀ取得開始ﾌﾗｸﾞ
CON
JMP @MR2001
;@DM70 = 1	'チャンネル番号
;@DM71 = 100	'タイムアウト
;@DM72 = 10	'データ取得時間(未使用)
;@DM73 = EM30020	'データ取得周期
;EM30070 = 0
LDP @MR2015              ; 検査ﾃﾞｰﾀ取得開始ﾌﾗｸﾞ
NCJ #1006
;@DM70 = 1	'チャンネル番号
;
LD CR2002                ; 常時ON
MOV #1 @DM70             ; (検査)通信ﾁｬﾝﾈﾙ番号
;@DM71 = 100	'タイムアウト
;
LD CR2002                ; 常時ON
MOV #100 @DM71           ; (検査)通信ﾀｲﾑｱｳﾄ
;@DM72 = 10	'データ取得時間(未使用)
;
LD CR2002                ; 常時ON
MOV #10 @DM72            ; (検査)ﾃﾞｰﾀ取得時間
;@DM73 = EM30020	'データ取得周期
;
LD CR2002                ; 常時ON
MOV EM30020 @DM73        ; (TP)サンプリング  (検査)ﾃﾞｰﾀ取得周期
;EM30070 = 0
LD CR2002                ; 常時ON
MOV #0 EM30070           ; (TP)検証動作表示用
LABEL #1006
;
LDP @MR2015              ; 検査ﾃﾞｰﾀ取得開始ﾌﾗｸﾞ
MSTRT INSPECT_DATA_3 #3 @DM70 FM0 @MR901 DM145 @MR2015;(検査)通信ﾁｬﾝﾈﾙ番号  ｴﾗｰﾌﾗｸﾞ  詳細ｴﾗｰｺｰﾄﾞ  検査ﾃﾞｰﾀ取得開始ﾌﾗｸﾞ
STG @MR2001
MPS
LDB @MR901               ; ｴﾗｰﾌﾗｸﾞ
AND @MR902               ; 終了フラグ
ANL
RES @MR2015              ; 検査ﾃﾞｰﾀ取得開始ﾌﾗｸﾞ
CON
ENDS
MPP
AND @MR901               ; ｴﾗｰﾌﾗｸﾞ
SET MR310                ; 通信ｴﾗｰ
CON
ENDS
;EM30070 = (FM0 -1) / 10 * 10
LD @MR2001
AND<> FM0 #0
NCJ #1005
;EM30070 = (FM0 -1) / 10 * 10
;;Warning[1103]: "=": (符号付き32ビット整数型->符号無し16ビット整数型) 代入によりデータが欠落する可能性があります。
LD CR2002                ; 常時ON
LDA FM0
CON
EXT
CON
SUB.L +1
CON
EXT.L
CON
DIV.L +10
CON
MUL.L +10
CON
STA EM30070              ; (TP)検証動作表示用
LABEL #1005
;
END
ENDH
